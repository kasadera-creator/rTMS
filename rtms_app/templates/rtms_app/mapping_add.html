{% extends "rtms_app/base.html" %}
{% load static %}

{% block body_class %}page-mapping{% endblock %}

{% block header_breadcrumb %}
    <span class="text-white-50 ms-2">/ 位置決め</span>
{% endblock header_breadcrumb %}

{% block extrastyle %}
<style>
  .section-title {
    border-left: 5px solid var(--color-mapping);
    padding-left: 10px;
    margin-bottom: 1.5rem;
  }

    /* Slightly larger base font for readability on mapping page */
    .mapping-page { font-size: 1.05rem; }

  /* iPad Landscape Optimization */
  @media only screen and (min-width: 1000px) and (orientation: landscape) {
      .container { max-width: 98vw; padding-bottom: 60px !important; }
      h3 { font-size: 1.2rem; margin-bottom: 0.5rem !important; }
      .alert { padding: 0.25rem 0.5rem; margin-bottom: 0.5rem !important; font-size: 0.85rem; }
      
    .card-header { padding: 0.25rem 0.5rem; font-size: 0.98rem; }
    .card-body { padding: 0.6rem; }
      
    .form-label { margin-bottom: 0; font-size: 0.95rem; }
    .form-control, .form-select, .input-group-text { padding: 0.25rem 0.4rem; font-size: 0.95rem; height: auto; }
      
      .section-title { margin-bottom: 0.5rem; font-size: 1rem; }
      .mb-3 { margin-bottom: 0.4rem !important; }
      .mb-4 { margin-bottom: 0.5rem !important; }
      
      /* History list compact */
    .list-group-item { padding: 0.45rem 0.6rem; font-size: 0.95rem; }
      
      /* Hide large bottom buttons in favor of FAB to save space */
      .text-center.my-4 { display: none; }
      
      .fab-stack { bottom: 15px; right: 15px; gap: 8px; }
      .fab { padding: 6px 10px; font-size: 14px; }
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 mb-5 mapping-page">
    {% include "rtms_app/partials/patient_inline_bar.html" with page_title="位置決め記録" title_icon="fa-crosshairs" patient=patient %}

    {# print toolbar is only for print preview pages; remove from regular screen #}

    <div class="row">
        <div class="col-md-8">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header card-header-accent fw-bold" style="--card-accent: var(--color-mapping);">
                    <i class="fas fa-pen me-1"></i> 新規記録
                </div>
                <div class="card-body bg-light">
                    <form method="post" id="mainForm">
                        {% csrf_token %}
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label fw-bold small">実施日</label>
                                {{ form.date }}
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-bold small">時期 (週数)</label>
                                {{ form.week_number }}
                            </div>
                        </div>
                        
                        <div class="card border-2 p-3 mb-3" style="border-color: var(--color-mapping) !important;">
                            <h5 class="fw-bold mb-3 section-title"><i class="fas fa-bolt me-2"></i>位置決めパラメータ</h5>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <label class="form-label fw-bold">MT（モーター閾値）</label>
                                    {{ form.resting_mt }}
                                    <div class="form-text small">ステップ: 1</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label fw-bold">位置 a（向かって左）</label>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <div class="input-group">
                                                <span class="input-group-text">X</span>
                                                {{ form.helmet_position_a_x }}
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="input-group">
                                                <span class="input-group-text">Y</span>
                                                {{ form.helmet_position_a_y }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label fw-bold">位置 b（向かって右）</label>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <div class="input-group">
                                                <span class="input-group-text">X</span>
                                                {{ form.helmet_position_b_x }}
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="input-group">
                                                <span class="input-group-text">Y</span>
                                                {{ form.helmet_position_b_y }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold small">備考</label>
                            {{ form.notes }}
                        </div>
                        <hr>
                        <!-- 保存操作はカードフッターへ移動 -->
                    </form>
                </div>

                <div class="card-footer bg-white border-0">
                    <div class="d-flex justify-content-center gap-3">
                        <button type="submit" form="mainForm" name="action" value="to_treatment" class="btn btn-success btn-lg px-4 fw-bold shadow-sm">
                            <i class="fas fa-arrow-right"></i> 本日の治療へ
                        </button>
                        <button type="submit" form="mainForm" name="action" value="save_and_return" class="btn btn-secondary btn-lg px-4 fw-bold shadow-sm">
                            <i class="fas fa-save"></i> 保存して戻る
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4 mapping-history">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header card-header-accent fw-bold" style="--card-accent: var(--color-mapping); background-color: #fff;">
                    <i class="fas fa-history me-1"></i> 履歴
                </div>
                <div class="list-group list-group-flush">
                    {% for item in history %}
                    <div class="list-group-item list-group-item-action">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <strong>{{ item.date|date:"Y/n/j" }}（{{ item.get_week_number_display }}）</strong>
                        </div>
                        <div class="text-muted small mb-1">
                            MT強度：<strong class="text-dark">{{ item.resting_mt }}</strong>
                            　位置：A({{ item.helmet_position_a_x|default:"-" }},{{ item.helmet_position_a_y|default:"-" }}) / B({{ item.helmet_position_b_x|default:"-" }},{{ item.helmet_position_b_y|default:"-" }})
                        </div>
                        {% if item.notes %}
                        <div class="small text-muted mt-1 border-top pt-1">
                            <i class="fas fa-comment-dots"></i> {{ item.notes }}
                        </div>
                        {% endif %}
                    </div>
                    {% empty %}
                    <div class="list-group-item text-center text-muted py-4">
                        記録はまだありません
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

 
{% endblock %}

{% block extrahead %}
<link rel="stylesheet" href="{% static 'rtms_app/mapping.css' %}">
{% endblock %}

{% block extrascript %}
<script>
// Auto-update week number when date changes (day1-based, week = floor(diff/7)+1)
(function(){
    const startDateStr = '{{ patient.first_treatment_date|default:""|date:"Y-m-d" }}';
    if (!startDateStr) return; // no start date available

    const start = new Date(startDateStr + 'T00:00:00');
    const dateEl = document.getElementById('id_date');
    const weekEl = document.getElementById('id_week_number');
    if (!dateEl || !weekEl) return;


    function computeWeekFor(dateStr){
        try{
            const d = new Date(dateStr + 'T00:00:00');
            const diffMs = d - start;
            const diffDays = Math.floor(diffMs / (1000*60*60*24));
            // If before start => return 0 to indicate '治療前'
            const wk = (diffDays < 0) ? 0 : Math.floor(diffDays/7) + 1;
            return wk;
        }catch(e){ return 0; }
    }

    function applyWeek(){
        const val = dateEl.value || new Date().toISOString().slice(0,10);
        const wk = computeWeekFor(val);
        if (wk === 0) {
            // ensure "治療前" option exists
            let preOpt = Array.from(weekEl.options).find(o => o.value === 'pre');
            if (!preOpt) {
                preOpt = document.createElement('option'); preOpt.value = 'pre'; preOpt.text = '治療前';
                // insert at beginning
                weekEl.insertBefore(preOpt, weekEl.firstChild);
            }
            weekEl.value = 'pre';
        } else {
            // set numeric week; if option missing, add it
            let opt = Array.from(weekEl.options).find(o => parseInt(o.value) === wk || o.text == ('第'+wk+'週');
            if (!opt) {
                opt = document.createElement('option'); opt.value = String(wk); opt.text = '第' + String(wk) + '週';
                weekEl.appendChild(opt);
            }
            weekEl.value = String(wk);
        }
    }

    dateEl.addEventListener('change', applyWeek);
    // initialize on load
    document.addEventListener('DOMContentLoaded', applyWeek);
    // also run immediately in case DOMContentLoaded already fired
    applyWeek();
})();
</script>
{% endblock %}