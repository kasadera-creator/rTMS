<div class="doc-title">入院時サマリ（rTMS）</div>

<div class="info-grid">
  <div><span class="label">氏名:</span> {{ patient.name }} 様</div>
  <div><span class="label">カルテID:</span> {{ patient.card_id }}</div>
  <div><span class="label">生年月日:</span> {{ patient.birth_date|date:"Y年n月j日" }}（{{ patient.age }}歳）</div>
  <div><span class="label">性別:</span> {{ patient.get_gender_display }}</div>

  <div><span class="label">紹介元:</span> {{ patient.referral_source|default:"-" }}</div>
  <div><span class="label">紹介医:</span> {{ patient.referral_doctor|default:"-" }}</div>

  <div><span class="label">担当医:</span>
    {% if patient.attending_physician %}
      {{ patient.attending_physician.last_name }}{{ patient.attending_physician.first_name|default:"" }}
    {% else %}
      未定
    {% endif %}
  </div>
</div>

<div class="section-heading">主訴</div>
<div class="note-box">
  {{ patient.chief_complaint|default:""|linebreaksbr }}
</div>

<div class="section-heading">生活歴</div>
<div class="note-box">
  {{ patient.life_history|default:""|linebreaksbr }}
</div>

<div class="section-heading">既往歴</div>
<div class="note-box">
  {{ patient.past_history|default:""|linebreaksbr }}
</div>

<div class="section-heading">現病歴</div>
<div class="note-box">
  {{ patient.present_illness|default:""|linebreaksbr }}
</div>

<div class="section-heading">薬物治療歴</div>
<div class="note-box">
  {{ patient.medication_history|default:""|linebreaksbr }}
</div>

<div class="section-heading">診断名</div>
<div class="note-box">
  {{ patient.diagnosis|default:"-" }}
</div>

<div class="section-heading">治療前評価（HAM-D）</div>
<table class="table-basic">
  <tr>
    <th style="width: 160px;">日付</th>
    <th style="width: 160px;">HAM-D17</th>
    <th style="width: 160px;">HAM-D21</th>
    <th>備考</th>
  </tr>

  {# assessments の中から baseline を拾う：viewで baseline_assessment を渡しているならそれを優先してもOK #}
  {% with baseline=None %}
    {% for score in assessments %}
      {% if score.timing == 'baseline' %}
        <tr>
          <td>{{ score.date|date:"Y-m-d" }}</td>
          <td>{{ score.total_score_17|default:"-" }}</td>
          <td>{{ score.total_score_21|default:"-" }}</td>
          <td>{{ score.note|default:""|linebreaksbr }}</td>
        </tr>
      {% endif %}
    {% endfor %}
  {% endwith %}

  {# baselineが無い場合の表示（簡易） #}
  {% if assessments|length == 0 %}
    <tr><td colspan="4">評価データは未入力です。</td></tr>
  {% endif %}
</table>

<div class="section-heading">治療予定（スケジュール）</div>
<table class="table-basic">
  <tr>
    <th>入院日</th>
    <th>位置決め日</th>
    <th>治療開始日</th>
    <th>治療終了予定（30回）</th>
  </tr>
  <tr>
    <td>{{ patient.admission_date|default:"-" }}</td>
    <td>{{ patient.mapping_date|default:"-" }}</td>
    <td>{{ patient.first_treatment_date|default:"-" }}</td>
    <td>{{ end_date_est|date:"Y-m-d"|default:"-" }}</td>
  </tr>
</table>

<div class="section-heading">治療経過・評価（一覧）</div>
<table class="table-basic">
  <tr>
    <th style="width: 120px;">日付</th>
    <th style="width: 120px;">タイミング</th>
    <th>HAM-D17</th>
    <th>HAM-D21</th>
    <th>備考</th>
  </tr>
  {% for score in assessments %}
    <tr>
      <td>{{ score.date|date:"Y-m-d" }}</td>
      <td>
        {% if score.timing == 'baseline' %}治療前評価
        {% elif score.timing == 'week3' %}3週時
        {% elif score.timing == 'week6' %}6週時
        {% else %}その他
        {% endif %}
      </td>
      <td>{{ score.total_score_17|default:"-" }}</td>
      <td>{{ score.total_score_21|default:"-" }}</td>
      <td>{{ score.note|default:""|linebreaksbr }}</td>
    </tr>
  {% empty %}
    <tr><td colspan="5">評価データは未入力です。</td></tr>
  {% endfor %}
</table>

{# ★重要：入院時サマリに「退院サマリ」「退院処方」を出さない #}
