{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>副作用チェック表 - {{ patient.last_name }}</title>
  <style>
    /* リセット & 基本設定 */
    @page { size: A4 portrait; margin: 15mm; }
    body { 
      font-family: "Hiragino Mincho ProN", "MS PMincho", serif; 
      color: #000; 
      margin: 0; padding: 20px; 
      width: 100%; box-sizing: border-box;
      background: white;
    }
    
    /* ユーティリティ */
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    .fw-bold { font-weight: bold; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mt-4 { margin-top: 1.5rem; }
    
    /* タイトル */
    h1.title {
      font-size: 22px; margin-bottom: 20px; 
      border-bottom: 2px solid #000; padding-bottom: 10px;
    }

    /* 基本情報セクション */
    .info-section { font-size: 14px; line-height: 1.8; margin-bottom: 15px; }
    .info-box {
      border: 1px solid #000; padding: 10px; margin-top: 10px;
      font-size: 13px;
    }
    
    /* テーブル */
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
    th, td { border: 1px solid #000; padding: 6px 4px; text-align: center; }
    th { background-color: #f0f0f0; }
    td.left-align { text-align: left; padding-left: 8px; }

    /* 署名・フッター */
    .footer-section { margin-top: 30px; font-size: 12px; display: flex; justify-content: space-between; }
    .signature-line { border-bottom: 1px solid #000; display: inline-block; width: 200px; }
    
    /* 画面表示用ボタン (印刷時は消える) */
    @media print {
      .no-print { display: none !important; }
    }
    .print-btn-container {
      position: fixed; top: 20px; right: 20px; 
      background: rgba(255,255,255,0.95); padding: 15px 20px; 
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .btn-print {
      padding: 10px 24px; cursor: pointer; font-size: 15px; font-weight: bold;
      background: #0d6efd; color: white; border: none; border-radius: 6px;
      box-shadow: 0 2px 6px rgba(13,110,253,0.3);
      transition: all 0.2s;
    }
    .btn-print:hover { background: #0b5ed7; transform: translateY(-1px); }
    .btn-close { 
      padding: 8px 16px; cursor: pointer; font-size: 14px;
      background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px;
      margin-left: 8px;
    }
  </style>
  <script>
    function printPage() { window.print(); }
    function closePage() { window.close(); }
    // window.addEventListener('load', () => window.print());
  </script>
</head>
<body>
  <div class="print-btn-container no-print">
    <button class="btn-print" onclick="printPage()"><i class="fas fa-print"></i> 印刷</button>
    <button class="btn-close" onclick="closePage()">閉じる</button>
  </div>

  <h1 class="title text-center">反復経頭蓋磁気刺激療法(rTMS)の副作用チェック表</h1>
  
  <div class="info-section">
    <div style="margin-bottom: 8px;">
      日付: 
      {% if session.date %}
        {{ session.date.year }}年 {{ session.date.month }}月 {{ session.date.day }}日 (時間: {{ session.date|date:"H:i" }})
      {% else %}
        _____年 ___月 ___日 (時間: )
      {% endif %}
    </div>
    <div style="margin-bottom: 8px;">
      患者氏名: {{ patient.name }} 様
    </div>
    <div style="margin-bottom: 8px;">
      施行者氏名: {% if session.performer %}{{ session.performer.last_name }} {{ session.performer.first_name }}{% else %}________________________{% endif %}
    </div>
  </div>

  <div class="info-box">
    <div style="margin-bottom: 5px;">使用したTMS治療器の種類: Brainsway</div>
    <div style="margin-bottom: 5px;">
      rTMSセッション回数: {{ session_number|default:"____" }}回目　　刺激部位: {{ session.target_site|default:"____" }}
    </div>
    <div style="margin-bottom: 5px;">
      刺激頻度: {{ session.frequency_hz|default:"__" }} Hz　　刺激強度: {{ session.intensity_percent|default:"__" }} %
    </div>
    <div>
      総パルス数: {{ session.total_pulses|default:"____" }} パルス/セッション
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width: 20%">症状</th>
        <th style="width: 8%">刺激前</th>
        <th style="width: 8%">刺激中</th>
        <th style="width: 8%">刺激後</th>
        <th style="width: 10%">関連性</th>
        <th style="width: 46%">メモ(対処法など)</th>
      </tr>
    </thead>
    <tbody>
      {% for row in side_effect_rows %}
      <tr>
        <td class="left-align">{{ row.item }}</td>
        <td>{% if row.before > 0 %}{{ row.before }}{% endif %}</td>
        <td>{% if row.during > 0 %}{{ row.during }}{% endif %}</td>
        <td>{% if row.after > 0 %}{{ row.after }}{% endif %}</td>
        <td>{% if row.relatedness > 0 %}{{ row.relatedness }}{% endif %}</td>
        <td class="left-align">{{ row.memo }}</td>
      </tr>
      {% empty %}
      {% for i in "12345678901"|make_list %}
      <tr><td style="height: 25px;"></td><td></td><td></td><td></td><td></td><td></td></tr>
      {% endfor %}
      {% endfor %}
    </tbody>
  </table>

  <div class="footer-section">
    <div style="width: 60%">
      <div><strong>重症度:</strong> 1-軽度、2-中等度、3-重度 (空欄はなし)</div>
      <div style="margin-top:5px;"><strong>関連性:</strong> 1-低い、2-あり、3-高い</div>
    </div>
    <div style="width: 40%; text-align: right;">
      <div style="margin-bottom: 40px;">
        担当医: 
        <span class="fw-bold" style="font-size: 1.2em; border-bottom: 1px solid #000; padding: 0 10px; display: inline-block; min-width: 150px; text-align: center;">
          {{ side_effect_signature|default:"" }}
        </span> (自署)
      </div>
      <div class="fw-bold" style="font-size: 14px;">笠寺精治療病院</div>
    </div>
  </div>

  </body>
</html>
