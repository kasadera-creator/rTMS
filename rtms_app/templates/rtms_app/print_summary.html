{% extends "rtms_app/base.html" %}

{% block extrastyle %}
<style>
    /* 画面表示用（プレビュー背景） */
    body { background-color: #525659; }
    .page-container {
        background-color: white;
        width: 210mm; /* A4幅 */
        min-height: 297mm;
        margin: 20px auto;
        padding: 20mm; /* 余白 */
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        position: relative;
        box-sizing: border-box;
    }

    /* 印刷時設定（重要） */
    @media print {
        @page { size: A4; margin: 0; }
        body { background-color: white; margin: 0; }
        .page-container { width: 100%; margin: 0; padding: 20mm; box-shadow: none; border: none; }
        .no-print { display: none !important; }
        /* URL印字の抑制 */
        a[href]:after { content: none !important; }
    }

    /* 文書内スタイル */
    h1.doc-title { text-align: center; font-size: 22pt; margin-bottom: 30px; font-family: "Hiragino Mincho ProN", serif; border-bottom: 2px solid #333; padding-bottom: 10px; }
    
    .referral-header { display: flex; justify-content: space-between; margin-bottom: 30px; }
    .referral-to { font-size: 14pt; text-decoration: underline; align-self: flex-start; margin-top: 20px; }
    .referral-from { text-align: right; font-size: 10pt; line-height: 1.6; }
    
    .summary-header { text-align: right; margin-bottom: 20px; font-size: 10pt; }

    .info-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11pt; }
    .info-table th, .info-table td { border-bottom: 1px solid #ccc; padding: 8px 4px; }
    .info-table th { width: 100px; text-align: left; color: #555; font-weight: normal; }
    .info-table td { font-weight: bold; }

    .content-section { margin-bottom: 20px; }
    .section-label { font-weight: bold; border-left: 4px solid #555; padding-left: 8px; margin-bottom: 8px; background-color: #eee; }
    .text-content { font-size: 11pt; line-height: 1.6; white-space: pre-wrap; text-align: justify; }

    /* スコアテーブル印刷用 */
    .print-score-table { width: 60%; margin-top: 10px; border-collapse: collapse; font-size: 10pt; }
    .print-score-table th, .print-score-table td { border: 1px solid #000; padding: 4px; text-align: center; }
    .print-score-table th { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; }

    .footer-area { margin-top: 50px; text-align: right; }
    .signature-line { display: inline-block; border-bottom: 1px solid #000; width: 250px; margin-left: 10px; }
</style>
{% endblock %}

{% block content %}
<!-- 印刷操作バー -->
<div class="container-fluid no-print bg-dark text-white p-2 fixed-top">
    <div class="container d-flex justify-content-between align-items-center">
        <span>
            {% if mode == 'referral' %}診療情報提供書プレビュー{% else %}退院サマリープレビュー{% endif %}
        </span>
        <div>
            <button onclick="window.print()" class="btn btn-primary btn-sm"><i class="fas fa-print"></i> 印刷</button>
            <button onclick="window.close()" class="btn btn-secondary btn-sm">閉じる</button>
        </div>
    </div>
</div>
<div style="height: 50px;" class="no-print"></div>

<div class="page-container">
    
    <!-- 1. ヘッダー部分（モードにより切り替え） -->
    {% if mode == 'referral' %}
        <!-- 紹介状モード -->
        <div class="referral-header">
            <div class="referral-to">
                {{ patient.referral_source|default:"紹介元医療機関" }}  御机下
            </div>
            <div class="referral-from">
                <div>{{ today|date:"Y年n月j日" }}</div>
                <div style="font-weight: bold; font-size: 12pt; margin: 5px 0;">笠寺精治寮病院</div>
                <div>〒457-0051 愛知県名古屋市南区笠寺町柚ノ木３</div>
                <div>TEL: 052-821-9221</div>
                <!-- 担当医: 印刷用なので last_name のみ (先生を除去) -->
                <div style="margin-top: 10px;">担当医: {{ patient.attending_physician.last_name }}</div>
            </div>
        </div>
        <h1 class="doc-title">診療情報提供書</h1>
        <p class="mb-4">いつも大変お世話になっております。<br>下記患者様につきまして、当院でのrTMS治療経過をご報告申し上げます。</p>

    {% else %}
        <!-- サマリーモード -->
        <div class="summary-header">
            <div>作成日: {{ today|date:"Y年n月j日" }}</div>
            <div>笠寺精治寮病院</div>
            <!-- 担当医: 印刷用なので last_name のみ -->
            <div>担当医: {{ patient.attending_physician.last_name }}</div>
        </div>
        <h1 class="doc-title">退院時サマリー</h1>
    {% endif %}


    <!-- 2. 患者情報（共通） -->
    <table class="info-table">
        <tr>
            <th>患者ID</th>
            <td>{{ patient.card_id }}</td>
            <th>氏名</th>
            <td>{{ patient.name }} 殿</td>
        </tr>
        <tr>
            <th>生年月日</th>
            <td>{{ patient.birth_date|date:"Y年n月j日" }} ({{ patient.age }}歳)</td>
            <th>性別</th>
            <td>{{ patient.get_gender_display }}</td>
        </tr>
        <tr>
            <th>入院期間</th>
            <td colspan="3">
                {{ patient.admission_date|date:"Y/n/j" }} 〜 {{ today|date:"Y/n/j" }}
            </td>
        </tr>
    </table>


    <!-- 3. 本文エリア -->
    <div class="content-section">
        <div class="section-label">診断名・主訴</div>
        <div class="text-content mb-3">
            診断名：{{ patient.diagnosis }}<br>
            主　訴：{{ patient.chief_complaint }}
        </div>

        <div class="section-label">入院経過・治療結果</div>
        <!-- 
           注意：現時点ではDBにサマリーテキストを保存していないため、
           手書き用に空けるか、views.pyで生成したテキストを表示する形になります。
        -->
        <div class="text-content" style="min-height: 250px; margin-bottom: 20px;">
            <!-- 自動生成テキストを表示したい場合は以下をコメントイン -->
            <!-- {{ summary_text|linebreaksbr }} -->
        </div>

        <!-- 心理検査経過表 -->
        {% if test_scores %}
        <div class="mt-3">
            <div style="font-weight: bold; font-size: 10pt; margin-bottom: 5px; border-bottom: 1px dashed #ccc; width: fit-content;">
                【参考】重症度評価推移 (HAMDスコア)
            </div>
            <table class="print-score-table">
                <tr>
                    <th style="width: 30%;">実施日</th>
                    <th style="width: 35%;">HAMD 17項目</th>
                    <th style="width: 35%;">HAMD 21項目</th>
                </tr>
                {% for score in test_scores %}
                <tr>
                    <td>{{ score.date|date:"Y/n/j" }}</td>
                    <td>{{ score.total_score_17 }}</td>
                    <td>{{ score.total_score_21 }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
        {% endif %}
    </div>
    
    <!-- 処方情報など（必要に応じて） -->
    {% if patient.medication_history %}
    <div class="content-section">
        <div class="section-label">処方薬</div>
        <div class="text-content">
            {{ patient.medication_history|linebreaksbr }}
        </div>
    </div>
    {% endif %}


    <!-- 4. フッター署名（紹介状モードのみ） -->
    {% if mode == 'referral' %}
    <div class="footer-area">
        <p>ご多忙の折、誠に恐縮ではございますが、<br>今後の加療を何卒よろしくお願い申し上げます。</p>
        <div style="margin-top: 40px;">
            医師署名：<span class="signature-line"></span>　印
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}