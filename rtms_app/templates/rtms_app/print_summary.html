{% extends "rtms_app/base.html" %}

{% block extrastyle %}
<style>
    /* 画面表示用（プレビュー背景） */
    body { background-color: #525659; }
    .page-container {
        background-color: white;
        width: 210mm; /* A4幅 */
        min-height: 297mm;
        margin: 20px auto;
        padding: 20mm; /* 余白 */
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        position: relative;
        box-sizing: border-box;
    }

    /* 印刷時設定（重要） */
    @media print {
        @page { size: A4; margin: 0; }
        body { background-color: white; margin: 0; }
        .page-container { width: 100%; margin: 0; padding: 15mm 20mm; box-shadow: none; border: none; }
        .no-print { display: none !important; }
        a[href]:after { content: none !important; }
    }

    /* 文書内スタイル */
    h1.doc-title { text-align: center; font-size: 20pt; margin-bottom: 25px; font-family: "Hiragino Mincho ProN", serif; border-bottom: 2px solid #333; padding-bottom: 8px; }
    
    .referral-header { display: flex; justify-content: space-between; margin-bottom: 25px; font-size: 10.5pt; }
    .referral-to { font-size: 13pt; text-decoration: underline; align-self: flex-start; margin-top: 15px; line-height: 1.4; }
    .referral-from { text-align: right; line-height: 1.5; }
    
    .summary-header { text-align: right; margin-bottom: 20px; font-size: 10.5pt; line-height: 1.5; }

    .info-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 10.5pt; }
    .info-table th, .info-table td { border-bottom: 1px solid #ccc; padding: 6px 4px; }
    .info-table th { width: 90px; text-align: left; color: #555; font-weight: normal; }
    .info-table td { font-weight: bold; }

    .content-section { margin-bottom: 15px; }
    .section-label { font-weight: bold; border-left: 4px solid #555; padding-left: 8px; margin-bottom: 6px; background-color: #eee; font-size: 10.5pt; }
    .text-content { font-size: 10pt; line-height: 1.5; white-space: pre-wrap; text-align: justify; }

    .print-score-table { width: 70%; margin-top: 8px; border-collapse: collapse; font-size: 9.5pt; }
    .print-score-table th, .print-score-table td { border: 1px solid #000; padding: 3px; text-align: center; }
    .print-score-table th { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; }

    .footer-area { margin-top: 40px; text-align: right; font-size: 10.5pt; }
    .signature-line { display: inline-block; border-bottom: 1px solid #000; width: 220px; margin-left: 10px; }
</style>
{% endblock %}

{% block content %}
<!-- 印刷操作バー -->
<div class="container-fluid no-print bg-dark text-white p-2 fixed-top">
    <div class="container d-flex justify-content-between align-items-center">
        <span>
            {% if mode == 'referral' %}診療情報提供書プレビュー{% else %}退院サマリープレビュー{% endif %}
        </span>
        <div>
            <button onclick="window.print()" class="btn btn-primary btn-sm"><i class="fas fa-print"></i> 印刷</button>
            <button onclick="window.close()" class="btn btn-secondary btn-sm">閉じる</button>
        </div>
    </div>
</div>
<div style="height: 50px;" class="no-print"></div>

<div class="page-container">
    
    <!-- 1. ヘッダー部分 -->
    {% if mode == 'referral' %}
        <div class="referral-header">
            <div class="referral-to">
                {{ patient.referral_source|default:"紹介元医療機関" }} <br>
                <span style="margin-left: 1em;">
                    {% if patient.referral_doctor %}{{ patient.referral_doctor }} 先生{% else %}担当医 先生{% endif %} 御机下
                </span>
            </div>
            <div class="referral-from">
                <div>{{ today|date:"Y年n月j日" }}</div>
                <div style="font-weight: bold; font-size: 11pt; margin: 3px 0;">笠寺精治寮病院</div>
                <div>〒457-0051 愛知県名古屋市南区笠寺町柚ノ木３</div>
                <div>TEL: 052-821-9221</div>
                <div style="margin-top: 8px;">担当医: {{ patient.attending_physician.last_name }} {{ patient.attending_physician.first_name }}</div>
            </div>
        </div>
        <h1 class="doc-title">診療情報提供書</h1>
        <p class="mb-4" style="font-size: 10.5pt;">いつも大変お世話になっております。<br>下記患者様につきまして、当院でのrTMS治療経過をご報告申し上げます。</p>

    {% else %}
        <div class="summary-header">
            <div>作成日: {{ today|date:"Y年n月j日" }}</div>
            <div>笠寺精治寮病院</div>
            <div>担当医: {{ patient.attending_physician.last_name }} {{ patient.attending_physician.first_name }}</div>
        </div>
        <h1 class="doc-title">退院時サマリー</h1>
    {% endif %}


    <!-- 2. 患者情報 -->
    <table class="info-table">
        <tr>
            <th>患者ID</th>
            <td>{{ patient.card_id }}</td>
            <th>氏名</th>
            <td>{{ patient.name }} 殿</td>
        </tr>
        <tr>
            <th>生年月日</th>
            <td>{{ patient.birth_date|date:"Y年n月j日" }} ({{ patient.age }}歳)</td>
            <th>性別</th>
            <td>{{ patient.get_gender_display }}</td>
        </tr>
        <tr>
            <th>入院期間</th>
            <td colspan="3">
                {{ patient.admission_date|date:"Y/n/j" }} 〜 
                <!-- ★修正: 退院日があれば退院日を、なければ今日を表示 -->
                {% if patient.discharge_date %}
                    {{ patient.discharge_date|date:"Y/n/j" }} (退院)
                {% else %}
                    {{ today|date:"Y/n/j" }} (入院中)
                {% endif %}
            </td>
        </tr>
    </table>


    <!-- 3. 本文エリア -->
    <div class="content-section">
        <div class="section-label">診断名・主訴</div>
        <div class="text-content mb-3">
            診断名：{{ patient.diagnosis }}<br>
            主　訴：{{ patient.chief_complaint }}
        </div>

        <div class="section-label">入院経過・治療結果</div>
        <div class="text-content" style="min-height: 200px; margin-bottom: 15px;">
            {{ patient.summary_text|linebreaksbr }}
        </div>

        <!-- 心理検査経過表 -->
        {% if test_scores %}
        <div class="mt-2">
            <div style="font-weight: bold; font-size: 9pt; margin-bottom: 3px; border-bottom: 1px dashed #ccc; width: fit-content;">
                【参考】重症度評価推移 (HAMDスコア)
            </div>
            <table class="print-score-table">
                <tr>
                    <th style="width: 30%;">実施日</th>
                    <th style="width: 35%;">HAMD 17項目</th>
                    <th style="width: 35%;">HAMD 21項目</th>
                </tr>
                {% for score in test_scores %}
                <tr>
                    <td>{{ score.date|date:"Y/n/j" }}</td>
                    <td>{{ score.total_score_17 }}</td>
                    <td>{{ score.total_score_21 }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
        {% endif %}
    </div>
    
    <!-- 退院時処方 -->
    <div class="content-section">
        <div class="section-label">退院時処方</div>
        <div class="text-content">
            {{ patient.discharge_prescription|linebreaksbr|default:"（記載なし）" }}
        </div>
    </div>


    <!-- 4. フッター署名 -->
    {% if mode == 'referral' %}
    <div class="footer-area">
        <p>ご多忙の折、誠に恐縮ではございますが、<br>今後の加療を何卒よろしくお願い申し上げます。</p>
        <div style="margin-top: 40px;">
            医師署名：<span class="signature-line"></span>　印
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}