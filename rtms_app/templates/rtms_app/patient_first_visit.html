{% extends "rtms_app/base.html" %}
{% load static %}
{% block body_class %}page-first-visit{% endblock body_class %}

{% block header_breadcrumb %}
  <span class="text-white-50 ms-2">/ 初診</span>
{% endblock header_breadcrumb %}

{% block extrastyle %}
<style>
  .fv-grid { display: grid; grid-template-columns: 1fr; gap: var(--space-4); }
  @media (min-width: 992px) {
    .fv-grid { grid-template-columns: 1.3fr 0.7fr; }
  }
  .kv { display: grid; grid-template-columns: 120px 1fr; gap: 0.35rem 0.75rem; font-size: var(--font-base); }
  .kv .k { color: var(--muted); font-weight: 700; }
  .kv .v { font-weight: 600; }

  .fv-ta { resize: vertical; }

  /* iPad landscape (1194×834): tighten right column + textareas, rely on modal for long edits */
  @media (max-width: 1194px) and (max-height: 834px) and (orientation: landscape) {
    .kv { grid-template-columns: 96px 1fr; gap: 0.25rem 0.6rem; font-size: 0.95rem; }
    .fv-ta { font-size: 0.92rem; line-height: 1.25; padding-top: 0.4rem; padding-bottom: 0.4rem; }
    textarea.fv-ta { height: 4.4em; }
    textarea.fv-ta.fv-ta--tall { height: 6.4em; }
  }
</style>
{% endblock extrastyle %}

{% block content %}
<div class="stack-md">
  {% include "rtms_app/partials/patient_inline_bar.html" with page_title="初診・基本情報入力" title_icon="fa-file-medical" patient=patient %}

  <form method="post" id="mainForm" class="form-rtms">
    {% csrf_token %}
    {# Hidden backing fields moved here after removing reference card #}
    <input type="hidden" name="card_id" value="{{ patient.card_id }}">
    <input type="hidden" name="name" value="{{ patient.name }}">
    <input type="hidden" name="birth_date" value="{{ patient.birth_date|date:'Y-m-d' }}">
    <input type="hidden" name="gender" value="{{ patient.gender }}">
    {% if form.errors %}
      <div class="alert alert-danger"><strong>保存できませんでした:</strong> {{ form.errors }}</div>
    {% endif %}

    <div class="fv-grid">
      <!-- ===== 1画面目: 主要入力（左） ===== -->
      <div class="stack-md">
        {# 基本情報（参照）カードはUIから削除。参照用の hidden フィールドは上部に移動しました。 #}

        <div class="card shadow-sm">
          <div class="card-header card-header-accent fw-bold" style="--card-accent: var(--color-first-visit);">
            <i class="fas fa-file-medical"></i> 紹介元〜薬剤治療歴
          </div>
          <div class="card-body">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">紹介元情報</label>
              <div class="row g-2">
                <div class="col-md-6">
                  <div class="input-group">
                    <span class="input-group-text bg-light">医療機関</span>
                    {{ form.referral_source }}
                  </div>
                  <datalist id="referral-options">
                    {% for opt in referral_options %}<option value="{{ opt }}">{% endfor %}
                  </datalist>
                </div>
                <div class="col-md-6">
                  <div class="input-group">
                    <span class="input-group-text bg-light">医師名</span>
                    {{ form.referral_doctor }}
                    <span class="input-group-text bg-light">先生</span>
                  </div>
                  <datalist id="doctor-options"></datalist>
                </div>
              </div>
            </div>

            <div class="col-12">
              <label class="form-label">主訴</label>
              {{ form.chief_complaint }}
            </div>

            <div class="col-md-6">
              <label class="form-label">生活歴</label>
              <textarea name="{{ form.life_history.name }}" class="form-control fv-ta" data-fv-modal="1" data-fv-label="生活歴" rows="3">{{ form.life_history.value|default_if_none:"" }}</textarea>
            </div>
            <div class="col-md-6">
              <label class="form-label">既往歴</label>
              <textarea name="{{ form.past_history.name }}" class="form-control fv-ta" data-fv-modal="1" data-fv-label="既往歴" rows="3">{{ form.past_history.value|default_if_none:"" }}</textarea>
            </div>

            <div class="col-12">
              <label class="form-label">現病歴</label>
              <textarea name="{{ form.present_illness.name }}" class="form-control fv-ta fv-ta--tall" data-fv-modal="1" data-fv-label="現病歴" rows="6">{{ form.present_illness.value|default_if_none:"" }}</textarea>
            </div>

            <div class="col-12">
              <label class="form-label">薬剤治療歴</label>
              <textarea name="{{ form.medication_history.name }}" class="form-control fv-ta fv-ta--tall" data-fv-modal="1" data-fv-label="薬剤治療歴" rows="5">{{ form.medication_history.value|default_if_none:"" }}</textarea>
            </div>
            
            <div class="col-12">
                <label class="form-label">原疾患（うつ病）の推定発症年月</label>
                <div class="d-flex flex-wrap gap-3 align-items-end">
                  <div class="d-flex gap-2 align-items-end">
                    <div>
                      <label class="form-label mb-1">推定発症</label>
                      <div class="d-flex gap-2 align-items-end">
                        <div>
                          {{ form.estimated_onset_year }} 年
                        </div>
                        <div>
                          {{ form.estimated_onset_month }} 月
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="d-flex gap-3 align-items-end ms-auto">
                    <div>
                      <label class="form-label mb-1">体重</label>
                      <div class="input-group" style="width: 12rem;">
                        {{ form.weight_kg }}
                        <span class="input-group-text">kg</span>
                      </div>
                    </div>

                    <div class="form-check d-flex align-items-center mb-1">
                      {{ form.is_weight_unknown }}
                      <label class="form-check-label ms-2" for="id_is_weight_unknown">不明</label>
                    </div>
                  </div>
                </div>
            </div>
          </div>
          </div>
        </div>
      </div>

      <!-- ===== 2画面目: 短い入力・導線（右） ===== -->
      <div class="stack-md">
        <div class="card shadow-sm">
          <div class="card-header card-header-accent fw-bold" style="--card-accent: var(--color-first-visit);">
            <i class="fas fa-user-md"></i> 診断名
          </div>
          <div class="card-body">
          {{ form.diagnosis }}

          <!-- Old diagnosis checklist removed. New UI renders below. -->

            <div class="mt-3">
            <label class="form-label">診断名（今回 rTMS の適応となるうつ病以外の精神疾患の既往）</label>
            <div>
              <div id="psychiatric-radio">
                <div class="d-flex flex-wrap gap-3 mt-2">
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="has_other_psychiatric_history" id="id_has_other_psychiatric_history_yes" value="yes" {% if form.has_other_psychiatric_history.value == "yes" %}checked{% endif %}>
                    <label class="form-check-label" for="id_has_other_psychiatric_history_yes">有</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="has_other_psychiatric_history" id="id_has_other_psychiatric_history_no" value="no" {% if form.has_other_psychiatric_history.value == "no" %}checked{% endif %}>
                    <label class="form-check-label" for="id_has_other_psychiatric_history_no">無</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="has_other_psychiatric_history" id="id_has_other_psychiatric_history_unknown" value="unknown" {% if form.has_other_psychiatric_history.value == "unknown" %}checked{% endif %}>
                    <label class="form-check-label" for="id_has_other_psychiatric_history_unknown">不明</label>
                  </div>
                </div>
                <!-- debug removed -->
              </div>
            </div>

            <div id="psychiatric-history-panel" class="d-none mt-3">
              <div class="small text-muted mb-2">該当する病名にチェックしてください</div>
              <div class="psy-list">
                <div class="row g-2">
                  {% for cb in form.psychiatric_history %}
                    <div class="col-12 col-md-6">
                      <div class="form-check">
                        {{ cb.tag }}
                        <label class="form-check-label" for="{{ cb.id_for_label }}">{{ cb.choice_label }}</label>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
              <div class="mt-2">
                <label class="form-label small">その他（自由記載）</label>
                {{ form.psychiatric_history_other_text }}
              </div>
            </div>
          </div>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-header card-header-accent fw-bold" style="--card-accent: var(--color-first-visit);">
            <i class="fas fa-clipboard-list"></i> 重症度評価 / 適正質問票
          </div>
          <div class="card-body">
          <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
            <div>
              <div class="fw-bold">HAM-D（治療前）</div>
              {% if baseline_assessment %}
                <div class="small muted">HAMD17: {{ baseline_assessment.total_score_17 }} / HAMD21: {{ baseline_assessment.total_score_21 }}</div>
                <div class="badge-rtms success mt-1">評価済</div>
              {% else %}
                <div class="badge-rtms gray mt-1">未入力</div>
              {% endif %}
            </div>
            <a class="btn btn-outline-assessment btn-sm" href="{% url 'rtms_app:assessment_add' patient.id 'baseline' %}{% if dashboard_date %}?dashboard_date={{ dashboard_date }}{% endif %}">入力する</a>
          </div>

          <hr class="my-3">

          <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
            <div>
              <div class="fw-bold">rTMS 適正質問票</div>
              {% if questionnaire_done %}
                <div class="badge-rtms success mt-1">入力済</div>
              {% else %}
                <div class="badge-rtms gray mt-1">未入力</div>
              {% endif %}
            </div>
            <a class="btn btn-outline-first-visit btn-sm" href="{% url 'rtms_app:questionnaire_edit' patient.id %}{% if dashboard_date %}?dashboard_date={{ dashboard_date }}{% endif %}">入力する</a>
          </div>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-header card-header-accent fw-bold" style="--card-accent: var(--color-first-visit);">
            <i class="fas fa-calendar-check"></i> スケジュール・担当医
          </div>
          <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6"><label class="form-label">入院予定日</label>{{ form.admission_date }}</div>
            <div class="col-md-6"><label class="form-label">初回治療日</label>{{ form.first_treatment_date }}</div>
            <div class="col-12"><label class="form-label">今後の担当医</label>{{ form.attending_physician }}</div>
            <div class="col-12 mt-2">
              <div class="form-check">
                {{ form.is_all_case_survey }}
                <label class="form-check-label" for="id_is_all_case_survey">全例調査対象（※該当時は4週目にもHAM-D指示）</label>
              </div>
            </div>
          </div>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-header card-header-accent fw-bold" style="--card-accent: var(--color-first-visit);">
            <i class="fas fa-print"></i> 印刷
          </div>
          <div class="card-body">
          <div class="small text-muted mb-2">初診時（合本）</div>
          <div class="d-flex flex-wrap gap-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="docs" value="admission" id="docAdmissionRight" checked form="bundlePrintFormFirstVisit">
              <label class="form-check-label" for="docAdmissionRight">入院時サマリ</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="docs" value="suitability" id="docSuitabilityRight" checked form="bundlePrintFormFirstVisit">
              <label class="form-check-label" for="docSuitabilityRight">rTMS問診票</label>
            </div>
          </div>
          <div class="mt-2 d-grid gap-2">
            <button type="submit" class="btn btn-primary btn-sm" form="bundlePrintFormFirstVisit">
              <i class="fas fa-print"></i> 印刷プレビュー
            </button>
            <a class="btn btn-outline-primary btn-sm" href="{% url 'rtms_app:latest_consent' %}" target="consent_pdf" rel="noopener">
              説明同意書を表示・印刷
            </a>
          </div>
          </div>
        </div>
      </div>
    </div>
  </form>

  <form id="bundlePrintFormFirstVisit" action="{% url 'rtms_app:print:patient_print_bundle' patient.id %}" method="get" target="_blank" class="d-none">
    {% if dashboard_date %}
      <input type="hidden" name="dashboard_date" value="{{ dashboard_date }}">
    {% endif %}
  </form>

  {% url 'rtms_app:dashboard' as dashboard_url %}
  {% if dashboard_date %}
    {% with back_url=dashboard_url|add:"?date="|add:dashboard_date %}
      <link rel="stylesheet" href="{% static 'rtms_app/floating.css' %}">
      <script src="{% static 'rtms_app/floating.js' %}"></script>

      <div class="fab-stack no-print">
        <button type="button" class="btn btn-first-visit fab"
                onclick="RTMSFloating.submitFormById('mainForm')">
          <i class="fas fa-save"></i> 保存
        </button>

        <a class="btn btn-secondary fab" href="{{ back_url }}">
          <i class="fas fa-undo"></i> 戻る
        </a>
      </div>
    {% endwith %}
  {% else %}
    <link rel="stylesheet" href="{% static 'rtms_app/floating.css' %}">
    <script src="{% static 'rtms_app/floating.js' %}"></script>

    <div class="fab-stack no-print">
      <button type="button" class="btn btn-first-visit fab"
              onclick="RTMSFloating.submitFormById('mainForm')">
        <i class="fas fa-save"></i> 保存
      </button>

      <a class="btn btn-secondary fab" href="{{ dashboard_url }}">
        <i class="fas fa-undo"></i> 戻る
      </a>
    </div>
  {% endif %}
  
{% endblock content %}

{% block scripts %}
<script>
  // 紹介元・紹介医の連携（アップロード版を維持）
  const referralMap = JSON.parse('{{ referral_map_json|safe }}');
  const sourceInput = document.querySelector('input[name="referral_source"]');
  const doctorInput = document.querySelector('input[name="referral_doctor"]');
  const doctorDatalist = document.getElementById('doctor-options');

  function updateDoctorOptions() {
    if (!sourceInput || !doctorDatalist) return;
    const selectedSource = sourceInput.value;
    doctorDatalist.innerHTML = '';
    if (referralMap[selectedSource]) {
      referralMap[selectedSource].forEach(docName => {
        const option = document.createElement('option');
        option.value = docName;
        doctorDatalist.appendChild(option);
      });
    }
  }

  if (sourceInput) {
    sourceInput.addEventListener('input', updateDoctorOptions);
    sourceInput.addEventListener('change', updateDoctorOptions);
  }
  if (doctorInput) doctorInput.setAttribute('list', 'doctor-options');

  document.addEventListener('DOMContentLoaded', function() {
    updateDoctorOptions();

    // (旧診断名復元ロジックを削除しました)

    // iPad-only textarea modal editing
    const ipadLandscape = window.matchMedia('(max-width: 1194px) and (max-height: 834px) and (orientation: landscape)');
    if (!ipadLandscape.matches) return;
    if (!window.bootstrap || !bootstrap.Modal) return;

    const modalEl = document.getElementById('fvTextareaModal');
    if (!modalEl) return;
    const modal = new bootstrap.Modal(modalEl);
    const titleEl = modalEl.querySelector('[data-fv-modal-title]');
    const taEl = modalEl.querySelector('textarea');
    const saveBtn = modalEl.querySelector('[data-fv-modal-save]');
    let activeField = null;

    function openModalFor(field) {
      activeField = field;
      const label = field.getAttribute('data-fv-label') || '入力';
      if (titleEl) titleEl.textContent = label;
      if (taEl) taEl.value = field.value || '';
      modal.show();
      setTimeout(() => { if (taEl) taEl.focus(); }, 50);
    }

    document.querySelectorAll('textarea[data-fv-modal="1"]').forEach(field => {
      field.addEventListener('focus', (e) => {
        e.preventDefault();
        openModalFor(field);
      });
      field.addEventListener('click', (e) => {
        e.preventDefault();
        openModalFor(field);
      });
    });

    if (saveBtn) {
      saveBtn.addEventListener('click', () => {
        if (activeField && taEl) {
          activeField.value = taEl.value;
          activeField.dispatchEvent(new Event('input', { bubbles: true }));
        }
        modal.hide();
      });
    }

    // --- Psychiatric history toggle (moved to robust init below) ---
  });
</script>

<script>
// Robust init for psychiatric-history-panel: immediate + pageshow + turbo/htmx aware
(function () {
  function init() {
    const radios = document.querySelectorAll('input[type="radio"][name="has_other_psychiatric_history"]');
    const panel = document.getElementById('psychiatric-history-panel');

    if (!radios || radios.length === 0) {
      console.debug('[psych] no radios found');
      return;
    }
    if (!panel) {
      console.debug('[psych] no panel found');
      return;
    }

    // Weight unknown toggle: disable weight input when unknown checked
    const weightInput = document.getElementById('id_weight_kg');
    const weightUnknownCheckbox = document.getElementById('id_is_weight_unknown');
    function syncWeight() {
      if (!weightInput || !weightUnknownCheckbox) return;
      if (weightUnknownCheckbox.checked) {
        weightInput.value = '';
        weightInput.disabled = true;
      } else {
        weightInput.disabled = false;
      }
    }
    if (weightUnknownCheckbox) weightUnknownCheckbox.addEventListener('change', syncWeight);
    // run once
    try { syncWeight(); } catch(e) { /* ignore */ }

    function clearPanelValues() {
      panel.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
      const ta = panel.querySelector('textarea[name="psychiatric_history_other_text"]');
      if (ta) ta.value = '';
    }

    function sync() {
      const checked = document.querySelector('input[type="radio"][name="has_other_psychiatric_history"]:checked');
      let val = checked ? checked.value : '';
      if (val === 'y') val = 'yes';
      if (val === 'n') val = 'no';

      const show = (val === 'yes');
      panel.classList.toggle('d-none', !show);
      if (!show) clearPanelValues();
    }

    // bind once
    if (!panel.dataset.bound) {
      radios.forEach(r => r.addEventListener('change', sync));
      document.body.addEventListener('change', function (e) {
        if (e && e.target && e.target.name === 'has_other_psychiatric_history') sync();
      });
      panel.dataset.bound = '1';
    }

    // restore existing selections from server-side data
    try {
      const existing = JSON.parse('{{ patient.psychiatric_history|default:"[]"|escapejs }}');
      if (Array.isArray(existing) && existing.length > 0) {
        existing.forEach(code => {
          const el = document.querySelector(`#psychiatric-history-panel input[type=checkbox][value="${code}"]`);
          if (el) el.checked = true;
        });
        const yesRadio = document.querySelector('input[type="radio"][name="has_other_psychiatric_history"][value="yes"]');
        if (yesRadio) yesRadio.checked = true;
      }
    } catch (e) {
      console.debug('[psych] restore error', e);
    }

    // run initial sync
    try { sync(); console.debug('[psych] init done'); } catch (e) { console.debug('[psych] sync error', e); }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
  window.addEventListener('pageshow', init);
  document.addEventListener('turbo:load', init);
  document.body.addEventListener('htmx:afterSwap', init);
})();
</script>

<div class="modal fade" id="fvTextareaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" data-fv-modal-title>入力</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea class="form-control" rows="12"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <button type="button" class="btn btn-primary" data-fv-modal-save>反映</button>
      </div>
    </div>
  </div>
</div>
{% endblock scripts %}
