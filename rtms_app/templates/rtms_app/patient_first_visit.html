{% extends "rtms_app/base.html" %}

{% block extrastyle %}
<style>
    /* ... (既存のスタイルはそのまま) ... */
    .form-section { background-color: #fff; padding: 25px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .section-title { border-left: 5px solid #0d6efd; padding-left: 10px; font-weight: bold; margin-bottom: 20px; color: #333; font-size: 1.2rem; }
    .diag-check-group { background-color: #f8f9fa; padding: 15px; border-radius: 5px; border: 1px solid #dee2e6; }
    .q-table { width: 100%; border-collapse: collapse; margin-bottom: 1rem; }
    .q-table th { background-color: #f8f9fa; padding: 10px; border-bottom: 2px solid #dee2e6; }
    .q-table td { padding: 8px 10px; border-bottom: 1px solid #dee2e6; vertical-align: middle; }
    .q-header-row { background-color: #e9ecef; font-weight: bold; }
    .floating-actions { position: fixed; bottom: 20px; right: 20px; z-index: 1050; display: flex; gap: 10px; }
    .btn-fab { border-radius: 30px; padding: 10px 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-weight: bold; }
    .hamd-input-group { border-bottom: 1px solid #eee; padding: 5px 0; }
    .hamd-label { font-size: 0.9rem; font-weight: bold; }
    .hamd-input { width: 60px; text-align: center; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 mb-5">
    <!-- ヘッダー (変更なし) -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fw-bold"><i class="fas fa-file-medical"></i> 初診・基本情報入力</h3>
        <div class="btn-group">
            <a href="{% url 'patient_print_preview' patient.id %}?mode=summary" target="_blank" class="btn btn-outline-primary"><i class="fas fa-print"></i> サマリー印刷</a>
            <a href="{% url 'patient_print_preview' patient.id %}?mode=questionnaire" target="_blank" class="btn btn-outline-success"><i class="fas fa-print"></i> 問診票印刷</a>
            <a href="{% url 'dashboard' %}{% if dashboard_date %}?date={{ dashboard_date }}{% endif %}" class="btn btn-secondary">戻る</a>
        </div>
    </div>

    <form method="post" id="mainForm">
        {% csrf_token %}
        
        <!-- (基本情報セクションは省略 - 変更なし) -->
        <div class="form-section">
            <h5 class="section-title">基本情報・サマリー</h5>
            <!-- ... -->
            <div class="mb-3"><label class="fw-bold">主訴</label>{{ form.chief_complaint }}</div>
            <!-- ... -->
            
            <div class="mb-3">
                <label class="fw-bold">診断名</label>
                {{ form.diagnosis }}
                
                <!-- 診断名チェックボックス (変更なし) -->
                <div class="diag-check-group mt-1">
                    <!-- ... -->
                </div>
            </div>

            <!-- ★移動: 治療前HAM-D評価 -->
            <div class="mt-3 p-3 bg-light border rounded">
                <div class="d-flex align-items-center">
                    <button type="button" class="btn btn-danger btn-sm me-3" data-bs-toggle="modal" data-bs-target="#hamdModal">
                        <i class="fas fa-chart-bar"></i> 治療前HAM-D評価
                    </button>
                    
                    <span id="hamd-result-display" class="fw-bold text-dark">
                        {% if baseline_assessment %}
                            HAM-D17: <span class="fs-5">{{ baseline_assessment.total_score_17 }}</span> 点 
                            <!-- 簡易判定表示ロジックはテンプレートでも可だが、JS更新と合わせるためシンプルに -->
                            (評価済)
                        {% else %}
                            <span class="text-muted small">※未実施</span>
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h5 class="section-title">スケジュール・担当医設定</h5>
             <!-- (変更なし) -->
             <div class="row g-3">
                <div class="col-md-4"><label class="form-label text-primary fw-bold">入院予定日</label>{{ form.admission_date }}</div>
                <div class="col-md-4"><label class="form-label text-warning fw-bold">初回位置決め日</label>{{ form.mapping_date }}</div>
                <div class="col-md-4"><label class="form-label text-success fw-bold">初回治療日</label>{{ form.first_treatment_date }}</div>
                <div class="col-md-8"><label class="form-label fw-bold">今後の担当医</label><div class="d-flex align-items-center">{{ form.attending_physician }}<span class="form-text ms-2 mb-0">※担当医を入力してください</span></div></div>
            </div>
        </div>

        <div class="form-section" id="q_section">
            <h5 class="section-title">rTMS 適正に関する質問票</h5>
             <!-- (変更なし) -->
             <table class="q-table">
                <!-- ... -->
             </table>
             <div class="mt-3"><label class="form-label fw-bold small">「はい」とチェックした項目について、より詳しくおしえてください</label><textarea name="q_details" class="form-control" rows="4"></textarea></div>
            <input type="hidden" name="questionnaire_data" id="questionnaire_json">
        </div>

        <div style="height: 50px;"></div>
        
        <div class="floating-actions">
            <button type="submit" class="btn btn-primary btn-fab text-white"><i class="fas fa-check"></i> 入力完了</button>
            <a href="{% url 'dashboard' %}{% if dashboard_date %}?date={{ dashboard_date }}{% endif %}" class="btn btn-secondary btn-fab"><i class="fas fa-undo"></i> 戻る</a>
        </div>
    </form>
</div>

<!-- HAM-D モーダル (変更なし) -->
<div class="modal fade" id="hamdModal" tabindex="-1">
    <!-- ... -->
</div>
{% endblock %}

{% block scripts %}
<script>
    // ... (既存スクリプト)

    // HAM-D Ajax保存・判定
    function saveHamd() {
        const form = document.getElementById('hamdForm');
        const formData = new FormData(form);
        formData.append('hamd_ajax', 'true');
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {'X-Requested-With': 'XMLHttpRequest'}
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                const modalEl = document.getElementById('hamdModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();

                // 結果表示の更新
                document.getElementById('hamd-result-display').innerHTML = 
                    `HAM-D17: <span class="fs-5">${data.total_17}</span> 点 判定: ${data.severity}`;

                // アラート表示
                alert(data.message);

                // 中等度(14-18)の場合、質問票へ誘導
                if (data.total_17 >= 14 && data.total_17 <= 18) {
                    const qSection = document.getElementById('q_section');
                    qSection.scrollIntoView({ behavior: 'smooth' });
                    // オプション: 質問票エリアを目立たせる
                    qSection.style.border = "2px solid #dc3545";
                    setTimeout(() => { qSection.style.border = "none"; }, 2000);
                }
            } else {
                alert('エラーが発生しました: ' + data.message);
            }
        });
    }

    // ... (既存スクリプト)
</script>
{% endblock %}