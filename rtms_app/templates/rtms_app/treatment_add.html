{% extends "rtms_app/base.html" %}
{% block extrastyle %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    /* 印刷時の制御 */
    @media print {
        @page { size: A4; margin: 15mm; }
        body * { visibility: hidden; }
        .printable-area, .printable-area * { visibility: visible; }
        .printable-area { position: absolute; left: 0; top: 0; width: 100%; color: #000; background: #fff; }
        .no-print, .btn, header, nav, footer, .floating-toolbar { display: none !important; }
        
        /* 印刷用ヘッダー表示 */
        .print-header-show { display: block !important; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 5px; text-align: center; }
        .print-row-show { display: flex !important; justify-content: space-between; margin-bottom: 10px; font-size: 12px; }
        
        /* テーブルの印刷調整 */
        table { width: 100%; border-collapse: collapse; font-size: 11pt; }
        th, td { border: 1px solid #000 !important; padding: 6px; }
        th { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; text-align: center; }
        
        /* 入力フォームの見た目リセット */
        textarea, input[type="text"], input[type="number"], select { border: none; background: transparent; resize: none; overflow: visible; font-size: inherit; width: auto; }
        .form-check-input { border: 1px solid #000; }
    }
    
    .print-header-show, .print-row-show { display: none; }
    .check-row:hover { background-color: #f8f9fa; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <h3 class="fw-bold"><i class="fas fa-bolt text-success"></i> 治療実施記録</h3>
        {% include "rtms_app/partials/patient_nav.html" %}
    </div>

    {% if alert_msg %}
    <div class="alert alert-danger fw-bold shadow-sm no-print mb-3">
        <i class="fas fa-exclamation-triangle"></i> {{ alert_msg }}
    </div>
    {% endif %}

    {% include "rtms_app/partials/form_header.html" %}

    <form method="post" id="treatmentForm">
        {% csrf_token %}
        
        <div class="row g-4 no-print">
            <div class="col-lg-6">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-light fw-bold text-success border-bottom">
                        <i class="fas fa-clock me-1"></i> 実施日時・安全確認
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label fw-bold">実施日</label>
                                {{ form.treatment_date }}
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-bold">開始時間</label>
                                {{ form.treatment_time }}
                            </div>
                        </div>
                        <div class="d-flex flex-column gap-2">
                            <div class="form-check form-switch p-2 border rounded bg-white">
                                {{ form.safety_sleep }} 
                                <label class="form-check-label fw-bold ms-1" for="{{ form.safety_sleep.id_for_label }}">睡眠不足なし</label>
                            </div>
                            <div class="form-check form-switch p-2 border rounded bg-white">
                                {{ form.safety_alcohol }} 
                                <label class="form-check-label fw-bold ms-1" for="{{ form.safety_alcohol.id_for_label }}">アルコール・カフェイン過剰なし</label>
                            </div>
                            <div class="form-check form-switch p-2 border rounded bg-white">
                                {{ form.safety_meds }} 
                                <label class="form-check-label fw-bold ms-1" for="{{ form.safety_meds.id_for_label }}">服薬変更なし</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-light fw-bold text-warning border-bottom">
                        <i class="fas fa-sliders-h me-1"></i> 治療パラメータ・指示
                    </div>
                    <div class="card-body">
                        <div class="bg-light p-3 rounded mb-3 border">
                            <div class="d-flex justify-content-between mb-2">
                                <small class="text-secondary fw-bold"><i class="fas fa-crosshairs"></i> 位置決め ({{ latest_mapping.date|default:"-" }})</small>
                                <small class="text-secondary fw-bold"><i class="fas fa-chart-line"></i> 3週目判定結果</small>
                            </div>
                            <div class="row">
                                <div class="col-6 border-end">
                                    <div>安静時MT: <strong class="fs-5">{{ latest_mapping.resting_mt|default:"-" }}%</strong></div>
                                    <div class="small text-muted">{{ latest_mapping.stimulation_site|default:"-" }}</div>
                                </div>
                                <div class="col-6 ps-3">
                                    {% if judgment_info %}
                                        <div class="fw-bold text-primary">{{ judgment_info }}</div>
                                        <div class="small text-danger fw-bold">{{ instruction_msg }}</div>
                                    {% else %}
                                        <div class="text-muted small">未実施・対象外</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <h6 class="fw-bold border-bottom pb-2 mb-3 small text-muted">本日の設定</h6>
                        <div class="row g-2">
                            <div class="col-4">
                                <label class="form-label fw-bold small">MT (%)</label>
                                {{ form.motor_threshold }}
                            </div>
                            <div class="col-4">
                                <label class="form-label fw-bold small">強度 (%)</label>
                                {{ form.intensity }}
                            </div>
                            <div class="col-4">
                                <label class="form-label fw-bold small">総パルス</label>
                                {{ form.total_pulses }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0 mt-4 mb-5 printable-area">
            <div class="card-header bg-white d-flex justify-content-between align-items-center border-bottom no-print">
                <div class="fw-bold text-primary"><i class="fas fa-notes-medical me-1"></i> 副作用チェック表</div>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="window.print()">
                    <i class="fas fa-print me-1"></i> チェック表を印刷
                </button>
            </div>
            
            <div class="card-body">
                <div class="print-header-show">
                    <h2>rTMS 副作用チェック表</h2>
                    <p style="text-align: right; font-size: 10px;">笠寺精治寮病院</p>
                </div>
                <div class="print-row-show">
                    <div style="width: 30%;">ID: <strong>{{ patient.card_id }}</strong></div>
                    <div style="width: 30%;">氏名: <strong>{{ patient.name }} 様</strong></div>
                    <div style="width: 40%; text-align: right;">
                        第<strong>{{ session_num }}</strong>回 ({{ form.treatment_date.value|default:"本日" }})
                    </div>
                </div>
                
                <p class="text-muted small no-print mb-2">※治療中・治療後の自覚症状について確認し、記入してください。</p>
                
                <table class="table table-bordered align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>症状</th>
                            <th width="80" class="text-center">なし<br><span class="small fw-normal">(None)</span></th>
                            <th width="80" class="text-center">軽度<br><span class="small fw-normal">(Mild)</span></th>
                            <th width="80" class="text-center">中等度<br><span class="small fw-normal">(Mod)</span></th>
                            <th width="80" class="text-center">重度<br><span class="small fw-normal">(Sev)</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for key, label in side_effect_items %}
                        <tr class="check-row">
                            <td>{{ label }}</td>
                            <td class="text-center"><input class="form-check-input" type="radio" name="se_{{ key }}" value="0" checked></td>
                            <td class="text-center"><input class="form-check-input" type="radio" name="se_{{ key }}" value="1"></td>
                            <td class="text-center"><input class="form-check-input" type="radio" name="se_{{ key }}" value="2"></td>
                            <td class="text-center"><input class="form-check-input" type="radio" name="se_{{ key }}" value="3"></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div class="mt-3">
                    <label class="form-label fw-bold">特記事項 (自由記載)</label>
                    <textarea name="se_note" class="form-control" rows="3"></textarea>
                </div>
                
                <div class="d-none d-print-block mt-5 text-end">
                    <p>実施者署名: ___________________________</p>
                </div>
            </div>
        </div>

                {% url 'rtms_app:dashboard' as dashboard_url %}
                {% if dashboard_date %}
                    {% with back_url=dashboard_url|add:"?date="|add:dashboard_date %}
                        {% include "rtms_app/partials/floating_actions.html" with back_url=back_url form_id='treatmentForm' %}
                    {% endwith %}
                {% else %}
                    {% include "rtms_app/partials/floating_actions.html" with back_url=dashboard_url form_id='treatmentForm' %}
                {% endif %}

    </form>
</div>
{% endblock %}