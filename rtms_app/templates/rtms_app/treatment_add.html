{% extends "rtms_app/base.html" %}
{% load static %}

{% block body_class %}page-treatment{% endblock %}

{% block extrastyle %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    /* 印刷時の制御 */
    @media print {
        @page { size: A4; margin: 15mm; }
        body * { visibility: hidden; }
        .printable-area, .printable-area * { visibility: visible; }
        .printable-area { position: absolute; left: 0; top: 0; width: 100%; color: #000; background: #fff; }
        .no-print, .btn, header, nav, footer, .floating-toolbar { display: none !important; }
        
        /* 印刷用ヘッダー表示 */
        .print-header-show { display: block !important; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 5px; text-align: center; }
        .print-row-show { display: flex !important; justify-content: space-between; margin-bottom: 10px; font-size: 12px; }
        
        /* テーブルの印刷調整 */
        table { width: 100%; border-collapse: collapse; font-size: 11pt; }
        th, td { border: 1px solid #000 !important; padding: 6px; }
        th { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; text-align: center; }
        
        /* 入力フォームの見た目リセット */
        textarea, input[type="text"], input[type="number"], select { border: none; background: transparent; resize: none; overflow: visible; font-size: inherit; width: auto; }
        .form-check-input { border: 1px solid #000; }
    }
    
    .print-header-show, .print-row-show { display: none; }
    .check-row:hover { background-color: #f8f9fa; }
</style>

{% endblock %}

{% block content %}
<div class="container py-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <h3 class="fw-bold"><i class="fas fa-bolt text-success"></i> 治療実施記録</h3>
        {% include "rtms_app/partials/patient_nav.html" %}
    </div>

    {% if alert_msg %}
    <div class="alert alert-danger fw-bold shadow-sm no-print mb-3">
        <i class="fas fa-exclamation-triangle"></i> {{ alert_msg }}
    </div>
    {% endif %}

    {% include "rtms_app/partials/form_header.html" %}

    <form method="post" id="treatmentForm">
        {% csrf_token %}
        
        <div class="row g-4 no-print">
            <div class="col-lg-6">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-light fw-bold text-success border-bottom">
                        <i class="fas fa-clock me-1"></i> 実施日時・安全確認
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label fw-bold">実施日</label>
                                {{ form.treatment_date }}
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-bold">開始時間</label>
                                {{ form.treatment_time }}
                            </div>
                        </div>
                        <div class="d-flex flex-column gap-2">
                            <div class="form-check form-switch p-2 border rounded bg-white">
                                {{ form.safety_sleep }} 
                                <label class="form-check-label fw-bold ms-1" for="id_safety_sleep">睡眠不足なし</label>
                            </div>
                            <div class="form-check form-switch p-2 border rounded bg-white">
                                {{ form.safety_alcohol }} 
                                <label class="form-check-label fw-bold ms-1" for="id_safety_alcohol">アルコール・カフェイン過剰なし</label>
                            </div>
                            <div class="form-check form-switch p-2 border rounded bg-white">
                                {{ form.safety_meds }} 
                                <label class="form-check-label fw-bold ms-1" for="id_safety_meds">服薬変更なし</label>
                            </div>
                        </div>
                        
                        <!-- 安全性警告エリア -->
                        <div id="safetyWarning" class="alert alert-warning alert-dismissible fade show mt-3 no-print" style="display: none;" role="alert">
                            <strong><i class="fas fa-exclamation-circle me-2"></i>注意</strong>
                            <div id="warningText" class="mt-2 fw-bold"></div>
                            <div class="mt-2">
                                <a href="#" id="mappingButton" class="btn btn-sm btn-outline-warning fw-bold">
                                    <i class="fas fa-crosshairs me-1"></i>今すぐ位置決めを実施
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card shadow-sm border-0 h-100">
                    <div class="card-header bg-light fw-bold text-warning border-bottom">
                        <i class="fas fa-sliders-h me-1"></i> 治療パラメータ・指示
                    </div>
                    <div class="card-body">
                        <div class="bg-light p-3 rounded mb-3 border">
                            <div class="d-flex justify-content-between mb-2">
                                <small class="text-secondary fw-bold"><i class="fas fa-crosshairs"></i> 位置決め ({{ current_week_mapping.date|default:"-" }})</small>
                                <small class="text-secondary fw-bold"><i class="fas fa-chart-line"></i> 今週の設定</small>
                            </div>
                            <div class="row">
                                <div class="col-6 border-end">
                                    <div>MT（モーター閾値）: <strong class="fs-5">{{ current_week_mapping.resting_mt|default:"-" }}</strong></div>
                                    <div class="small text-muted">位置: A({{ current_week_mapping.helmet_position_a_x|default:"-" }},{{ current_week_mapping.helmet_position_a_y|default:"-" }}) / B({{ current_week_mapping.helmet_position_b_x|default:"-" }},{{ current_week_mapping.helmet_position_b_y|default:"-" }})</div>
                                </div>
                                <div class="col-6 ps-3">
                                    {% if judgment_info %}
                                        <div class="fw-bold text-primary">{{ judgment_info }}</div>
                                        <div class="small text-danger fw-bold">{{ instruction_msg }}</div>
                                    {% else %}
                                        <div class="text-muted small">未実施・対象外</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <h6 class="fw-bold border-bottom pb-2 mb-3 small text-muted">本日の設定</h6>
                        <div class="row g-2">
                            <div class="col-4">
                                <label class="form-label fw-bold small">刺激強度 (%)</label>
                                {{ form.mt_percent }}
                            </div>
                            <div class="col-4">
                                <label class="form-label fw-bold small">周波数 (Hz)</label>
                                {{ form.frequency_hz }}
                            </div>
                            <div class="col-4">
                                <label class="form-label fw-bold small">刺激時間 (s)</label>
                                {{ form.train_seconds }}
                            </div>
                        </div>
                        <div class="row g-2 mt-2">
                            <div class="col-4">
                                <label class="form-label fw-bold small">刺激間隔 (s)</label>
                                {{ form.intertrain_seconds }}
                            </div>
                            <div class="col-4">
                                <label class="form-label fw-bold small">トレイン数</label>
                                {{ form.train_count }}
                            </div>
                            <div class="col-4">
                                <label class="form-label fw-bold small">総パルス</label>
                                {{ form.total_pulses }}
                            </div>
                        </div>
                        <div class="mt-2">
                            <label class="form-label fw-bold small">備考</label>
                            {{ form.treatment_notes }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0 mt-4 mb-5 printable-area">
            <div class="card-header bg-white d-flex justify-content-between align-items-center border-bottom no-print">
                <div class="fw-bold text-primary"><i class="fas fa-notes-medical me-1"></i> rTMS副作用チェック表</div>
            </div>
            
            <div class="card-body">
                <div class="print-header-show">
                    <h2 style="text-align: center; margin-bottom: 15px; font-size: 18px;">rTMS 副作用チェック表</h2>
                    <p style="text-align: right; font-size: 10px; margin-bottom: 10px;">笠寺精治寮病院</p>
                </div>
                <div class="print-row-show">
                    <div style="width: 25%;">ID: <strong>{{ patient.card_id }}</strong></div>
                    <div style="width: 25%;">氏名: <strong>{{ patient.name }}</strong></div>
                    <div style="width: 25%;">施行者: <strong>{{ request.user.get_full_name|default:request.user.username }}</strong></div>
                    <div style="width: 25%; text-align: right;">第<strong>{{ session_num }}</strong>回</div>
                </div>
                
                {{ side_effect_rows_json|default:'[]'|json_script:"sideEffectInitialRows" }}
                <div id="sideEffectWidget" data-initial-id="sideEffectInitialRows"></div>
                <input type="hidden" name="side_effect_rows_json" id="sideEffectRowsJson" value="{{ side_effect_rows_json|default:'[]'|escape }}">

                <div class="row g-3 mt-4" style="display: none;">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">担当医（自署）</label>
                        <input type="text" class="form-control" name="side_effect_signature" value="{{ side_effect_signature|default:'' }}">
                    </div>
                </div>

                <div class="mt-3" style="display: none;">
                    <label class="form-label fw-bold">メモ（対処法など）</label>
                    <textarea class="form-control" name="side_effect_memo" rows="3">{{ side_effect_memo|default:'' }}</textarea>
                </div>

                <div class="small text-muted mt-3 no-print">
                    重症度：0=なし、1=軽度、2=中等度、3=重度 ／ 関連性：0=なし、1=低い、2=あり、3=高い
                </div>
            </div>
        </div>

        {% url 'rtms_app:dashboard' as dashboard_url %}
        <link rel="stylesheet" href="{% static 'rtms_app/floating.css' %}">
        <script src="{% static 'rtms_app/floating.js' %}"></script>

        {% if dashboard_date %}
            {% with back_url=dashboard_url|add:"?date="|add:dashboard_date %}
                <div class="fab-stack no-print">
                  <!-- Single unified print preview button -->
                  <button type="button" class="btn btn-primary fab" id="printBtn">
                    <i class="fas fa-print"></i> 印刷プレビュー
                  </button>

                  <button type="submit" class="btn btn-treatment fab" form="treatmentForm">
                    <i class="fas fa-save"></i> 保存
                  </button>

                  <a class="btn btn-secondary fab" href="{{ back_url }}">
                    <i class="fas fa-undo"></i> 戻る
                  </a>
                </div>
            {% endwith %}
        {% else %}
            <div class="fab-stack no-print">
              <!-- Single unified print preview button -->
              <button type="button" class="btn btn-primary fab" id="printBtn">
                <i class="fas fa-print"></i> 印刷プレビュー
              </button>
                
              <button type="submit" class="btn btn-treatment fab" form="treatmentForm">
                <i class="fas fa-save"></i> 保存
              </button>
                
              <a class="btn btn-secondary fab" href="{{ dashboard_url }}">
                <i class="fas fa-undo"></i> 戻る
              </a>
            </div>
        {% endif %}

    </form>
</div>

<script src="{% static 'rtms_app/side_effect_widget_v2.js' %}"></script>
<script>
  console.log('[treatment_add template] Script loaded');
  
  // Warning logic for safety conditions
  function checkSafetyWarnings() {
    const sleepCheckbox = document.getElementById('id_safety_sleep');
    const alcoholCheckbox = document.getElementById('id_safety_alcohol');
    const medsCheckbox = document.getElementById('id_safety_meds');
    
    const warningDiv = document.getElementById('safetyWarning');
    if (!warningDiv) return;
    
    const warningText = document.getElementById('warningText');
    const mappingButton = document.getElementById('mappingButton');
    
    if (!sleepCheckbox || !alcoholCheckbox || !medsCheckbox) return;
    
    if (!sleepCheckbox.checked || !alcoholCheckbox.checked || !medsCheckbox.checked) {
      const mappingUrl = '{% url "rtms_app:mapping_add" patient.id %}?date={{ initial_date|date:"Y-m-d" }}';
      warningText.innerHTML = '<i class="fas fa-bolt text-warning me-1"></i>適切な刺激強度が変わっている可能性があります。<br>位置決めを実施してください。';
      mappingButton.href = mappingUrl;
      mappingButton.target = '_self';
      warningDiv.classList.remove('alert-info');
      warningDiv.classList.add('alert-warning');
      warningDiv.style.display = 'block';
    } else {
      warningDiv.style.display = 'none';
    }
  }
  
  document.addEventListener('DOMContentLoaded', () => {
    console.log('[treatment_add template] DOMContentLoaded fired');
    
    const sleepElem = document.getElementById('id_safety_sleep');
    const alcoholElem = document.getElementById('id_safety_alcohol');
    const medsElem = document.getElementById('id_safety_meds');
    
    if (sleepElem) sleepElem.addEventListener('change', checkSafetyWarnings);
    if (alcoholElem) alcoholElem.addEventListener('change', checkSafetyWarnings);
    if (medsElem) medsElem.addEventListener('change', checkSafetyWarnings);
    
    checkSafetyWarnings();
    console.log('[treatment_add template] Safety checks initialized');
    
    // Immediate sync on widget instance creation
    if (typeof sideEffectWidgetInstance !== 'undefined' && sideEffectWidgetInstance) {
      console.log('[treatment_add template] Widget instance exists, performing initial sync');
      sideEffectWidgetInstance.updateHiddenInput();
    }
    
    // Ensure side_effect_rows_json is synced before form submission
    const treatmentForm = document.getElementById('treatmentForm');
    if (treatmentForm) {
      treatmentForm.addEventListener('submit', (e) => {
        console.log('[treatment_add template] Form submit event');
        
        // Multiple sync attempts to ensure data is captured
        if (typeof sideEffectWidgetInstance !== 'undefined' && sideEffectWidgetInstance) {
          console.log('[treatment_add template] Syncing widget data (1st attempt)...');
          sideEffectWidgetInstance.updateHiddenInput();
          
          // Wait a tick and sync again
          setTimeout(() => {
            console.log('[treatment_add template] Syncing widget data (2nd attempt)...');
            sideEffectWidgetInstance.updateHiddenInput();
            
            const hiddenInput = document.getElementById('sideEffectRowsJson');
            if (hiddenInput) {
              console.log('[treatment_add template] Final sideEffectRowsJson value:', hiddenInput.value);
            }
          }, 0);
        } else {
          console.warn('[treatment_add template] Widget instance not available');
        }
      });
      
      // Attach handler for always-visible print button (unsaved sessions)
      const printBtn = document.getElementById('printBtn');
      if (printBtn) {
        printBtn.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('[treatment_add template] printBtn clicked');

          if (typeof sideEffectWidgetInstance !== 'undefined' && sideEffectWidgetInstance) {
            sideEffectWidgetInstance.updateHiddenInput();
          }

          let actionInput = document.getElementById('actionInput');
          if (!actionInput) {
            actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.id = 'actionInput';
            actionInput.name = 'action';
            treatmentForm.appendChild(actionInput);
          }
          actionInput.value = 'print';
          console.log('[treatment_add template] Submitting form with action=print via printBtn');
          treatmentForm.submit();
        });
      }
      
      // Also sync when floating menu button is clicked
      const submitBtn = treatmentForm.querySelector('button[type="submit"]');
      if (submitBtn) {
        submitBtn.addEventListener('click', (e) => {
          console.log('[treatment_add template] Submit button clicked');
          if (typeof sideEffectWidgetInstance !== 'undefined' && sideEffectWidgetInstance) {
            console.log('[treatment_add template] Syncing before button click');
            sideEffectWidgetInstance.updateHiddenInput();
          }
        });
      }
    }
  });
</script>
{% endblock %}
