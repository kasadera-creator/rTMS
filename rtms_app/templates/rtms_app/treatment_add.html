{% extends "admin/base_site.html" %}
{% block extrastyle %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    .section-title { background-color: #f8f9fa; padding: 10px; border-left: 5px solid #28a745; font-weight: bold; margin-bottom: 20px;}
    .check-row:hover { background-color: #f1f1f1; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 mb-5">
    <div class="d-flex justify-content-between mb-4">
        <h3>治療実施記録: {{ patient.name }} 殿</h3>
        <a href="{% url 'dashboard' %}" class="btn btn-secondary">戻る</a>
    </div>

    <form method="post">
        {% csrf_token %}
        
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-warning text-dark fw-bold">最新の位置決め情報 (Reference)</div>
            <div class="card-body">
                {% if latest_mapping %}
                <div class="row">
                    <div class="col-md-4"><strong>実施日:</strong> {{ latest_mapping.date }}</div>
                    <div class="col-md-4"><strong>安静時MT:</strong> {{ latest_mapping.resting_mt }} %</div>
                    <div class="col-md-4"><strong>刺激部位:</strong> {{ latest_mapping.stimulation_site }}</div>
                </div>
                {% else %}
                <div class="text-danger">※位置決め記録がまだありません。初回治療前に位置決めを行ってください。</div>
                {% endif %}
            </div>
        </div>

        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h5 class="section-title">実施日時・安全確認</h5>
                <div class="row mb-3">
                    <div class="col-md-4">
                        {{ form.date.label_tag }}
                        {{ form.date }}
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-check form-switch py-2">
                            {{ form.safety_sleep }}
                            <label class="form-check-label fw-bold">睡眠不足なし</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check form-switch py-2">
                            {{ form.safety_alcohol }}
                            <label class="form-check-label fw-bold">アルコール・カフェイン過剰なし</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-check form-switch py-2">
                            {{ form.safety_meds }}
                            <label class="form-check-label fw-bold">服薬変更なし</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h5 class="section-title">治療パラメータ</h5>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">当日のMT (%)</label>
                        {{ form.motor_threshold }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">刺激強度 (%)</label>
                        {{ form.intensity }}
                        <small class="text-muted">通常 120%</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">総パルス数</label>
                        {{ form.total_pulses }}
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4 shadow-sm">
            <div class="card-body">
                <h5 class="section-title">副作用チェック表</h5>
                <p class="text-muted small">治療中・治療後の自覚症状について確認してください。</p>
                
                <table class="table table-hover table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>症状</th>
                            <th width="100" class="text-center">なし</th>
                            <th width="100" class="text-center">軽度</th>
                            <th width="100" class="text-center">中等度</th>
                            <th width="100" class="text-center">重度</th>
                        </tr>
                    </thead>
                    <tbody>
                        <input type="hidden" name="side_effects" id="side_effects_json">
                        
                        {% for key, label in "headache:頭痛,scalp:頭皮痛,tooth:歯痛,twitch:顔面攣縮,dizzy:めまい,nausea:吐き気,tinnitus:耳鳴り,anxiety:不安感"|slice:"," %}
                        {% endfor %}

                        <tr class="check-row">
                            <td>頭皮痛 (刺激痛)</td>
                            <td class="text-center"><input type="radio" name="se_scalp" value="0" checked></td>
                            <td class="text-center"><input type="radio" name="se_scalp" value="1"></td>
                            <td class="text-center"><input type="radio" name="se_scalp" value="2"></td>
                            <td class="text-center"><input type="radio" name="se_scalp" value="3"></td>
                        </tr>
                        <tr class="check-row">
                            <td>頭痛</td>
                            <td class="text-center"><input type="radio" name="se_headache" value="0" checked></td>
                            <td class="text-center"><input type="radio" name="se_headache" value="1"></td>
                            <td class="text-center"><input type="radio" name="se_headache" value="2"></td>
                            <td class="text-center"><input type="radio" name="se_headache" value="3"></td>
                        </tr>
                        <tr class="check-row">
                            <td>歯痛</td>
                            <td class="text-center"><input type="radio" name="se_tooth" value="0" checked></td>
                            <td class="text-center"><input type="radio" name="se_tooth" value="1"></td>
                            <td class="text-center"><input type="radio" name="se_tooth" value="2"></td>
                            <td class="text-center"><input type="radio" name="se_tooth" value="3"></td>
                        </tr>
                        <tr class="check-row">
                            <td>顔面のけいれん</td>
                            <td class="text-center"><input type="radio" name="se_twitch" value="0" checked></td>
                            <td class="text-center"><input type="radio" name="se_twitch" value="1"></td>
                            <td class="text-center"><input type="radio" name="se_twitch" value="2"></td>
                            <td class="text-center"><input type="radio" name="se_twitch" value="3"></td>
                        </tr>
                        </tbody>
                </table>
                
                <div class="mt-3">
                    <label class="form-label fw-bold">特記事項 (自由記載)</label>
                    <textarea name="se_note" class="form-control" rows="2"></textarea>
                </div>
            </div>
        </div>

        <div class="text-center">
            <button type="submit" class="btn btn-success btn-lg px-5">登録完了</button>
        </div>
    </form>
</div>

<script>
    // 送信時に副作用データをJSON化
    document.querySelector('form').addEventListener('submit', function(e) {
        // ラジオボタンの値を収集するロジック
        // (簡易実装: 全ての radio:checked を拾う)
        const effects = {};
        document.querySelectorAll('input[type="radio"]:checked').forEach(el => {
            if(el.name.startsWith('se_')) {
                effects[el.name.replace('se_', '')] = el.value;
            }
        });
        effects['note'] = document.querySelector('textarea[name="se_note"]').value;
        
        // input hiddenにセット (TreatmentSession.side_effects に対応)
        // ※Django側でこのフィールド名を受け取る設定が必要ですが、
        // 今回のviews.pyでは一旦フォーム保存のみにしています。
        // 本当は `form.cleaned_data['side_effects']` に渡す必要があります。
    });
</script>
{% endblock %}