{% extends "rtms_app/base.html" %}

{% block extrastyle %}
<style>
    body { background-color: #525659; }
    .page-container { width: 210mm; margin: 20px auto; }
    .page-sheet {
        background-color: white; width: 100%; min-height: 297mm; 
        padding: 10mm; 
        box-shadow: 0 0 10px rgba(0,0,0,0.5); position: relative; box-sizing: border-box; margin-bottom: 20px;
        font-family: "Hiragino Mincho ProN", "Yu Mincho", "MS PMincho", serif; color: #000; 
        line-height: 1.3;
    }

    /* カレンダースタイル */
    .path-table { width: 100%; border-collapse: collapse; font-size: 10pt; }
    .path-table th, .path-table td { border: 1px solid #000; padding: 5px; }
    .path-table th { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; text-align: center; }
    .path-date { width: 120px; text-align: center; }
    .path-event { text-align: left; }
    .path-weekend { background-color: #fafafa !important; -webkit-print-color-adjust: exact; color: #555; }
    
    /* イベントバッジ風スタイル（印刷対応） */
    .evt-admission { font-weight: bold; color: #0d6efd; }
    .evt-mapping { font-weight: bold; color: #fd7e14; }
    .evt-treatment { color: #198754; }
    .evt-assessment { font-weight: bold; color: #dc3545; border: 1px solid #dc3545; padding: 1px 4px; border-radius: 4px; font-size: 0.9em; display: inline-block; margin-left: 5px; }
    .evt-discharge { font-weight: bold; color: #0dcaf0; font-size: 1.1em; }

    /* 裏面スタイル */
    .instruction-box { border: 2px solid #333; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
    .inst-title { font-size: 14pt; font-weight: bold; border-bottom: 1px solid #000; margin-bottom: 10px; padding-bottom: 5px; }
    .inst-content { font-size: 11pt; line-height: 1.6; }
    .inst-content ul { padding-left: 20px; margin: 0; }
    .inst-content li { margin-bottom: 5px; }

    @media print {
        @page { size: A4; margin: 0; }
        body { background-color: white; margin: 0; }
        .preview-container { width: 100%; margin: 0; }
        .page-sheet { 
            width: 100%; margin: 0; padding: 10mm 15mm; box-shadow: none; border: none; min-height: 297mm;
            page-break-after: always;
        }
        .page-sheet:last-child { page-break-after: auto; }
        .no-print { display: none !important; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid no-print bg-dark text-white p-2 fixed-top">
    <div class="container d-flex justify-content-between align-items-center">
        <span>クリニカルパス (患者用)</span>
        <div>
            <button onclick="window.print()" class="btn btn-primary btn-sm"><i class="fas fa-print"></i> 印刷 (表裏)</button>
            <button onclick="window.close()" class="btn btn-secondary btn-sm">閉じる</button>
        </div>
    </div>
</div>
<div style="height: 50px;" class="no-print"></div>

<div class="page-container">
    
    <!-- 1ページ目: スケジュールカレンダー -->
    <div class="page-sheet">
        <h2 class="text-center fw-bold mb-4">rTMS治療スケジュール表</h2>
        
        <div class="d-flex justify-content-between mb-3 border-bottom pb-2">
            <div class="fs-5">氏名: <strong>{{ patient.name }} 様</strong></div>
            <div class="fs-5">ID: {{ patient.card_id }}</div>
            <div class="fs-5">担当医: {{ patient.attending_physician.last_name }}</div>
        </div>
        
        <table class="path-table">
            <thead>
                <tr>
                    <th>日付</th>
                    <th>曜日</th>
                    <th>予定・内容</th>
                </tr>
            </thead>
            <tbody>
                {% for day in calendar_days %}
                <tr class="{% if day.is_weekend %}path-weekend{% endif %}">
                    <td class="text-center">{{ day.date|date:"n/j" }}</td>
                    <td class="text-center">{{ day.weekday }}</td>
                    <td class="path-event">
                        {% for event in day.events %}
                            <div class="evt-{{ event.type }}">{{ event.label }}</div>
                        {% endfor %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="mt-2 small text-end">※スケジュールは治療経過により変更になる場合があります。</div>
    </div>

    <!-- 2ページ目: 注意事項 -->
    <div class="page-sheet">
        <h2 class="text-center fw-bold mb-5">rTMS治療を受ける患者様へ</h2>
        
        <div class="instruction-box">
            <div class="inst-title">① 入院日のご案内</div>
            <div class="inst-content">
                <ul>
                    <li>指定された時間（通常午前10時頃）に受付へお越しください。</li>
                    <li>保険証、診察券、現在服用中のお薬、お薬手帳を必ずご持参ください。</li>
                    <li>病棟にて看護師より入院生活についてのオリエンテーションがあります。</li>
                    <li>入院当日は、治療前の最終確認と、翌日以降のスケジュール調整を行います。</li>
                </ul>
            </div>
        </div>

        <div class="instruction-box">
            <div class="inst-title">② 位置決め（MT測定）について</div>
            <div class="inst-content">
                <ul>
                    <li>治療を行うための最適な刺激部位と、刺激の強さ（MT: モーター閾値）を決める重要な検査です。</li>
                    <li><strong>整髪料（ワックス、スプレー等）は付けずに</strong>、洗髪した清潔な状態で検査を受けてください。</li>
                    <li>頭にキャップを被り、測定を行います。所要時間は約30分〜1時間です。</li>
                    <li>測定中は親指がピクッと動くか確認しますので、リラックスして受けてください。</li>
                </ul>
            </div>
        </div>

        <div class="instruction-box">
            <div class="inst-title">③ 初回治療と毎回の治療について</div>
            <div class="inst-content">
                <ul>
                    <li>治療時間は約40分です。治療中は「カチカチ」という音と、頭皮を叩かれるような刺激があります。</li>
                    <li>音が大きいため、必ず<strong>耳栓（当院で用意します）を着用</strong>してください。</li>
                    <li>治療中に頭痛や歯の痛み、不快感を感じた場合は、すぐにスタッフへお知らせください。刺激位置や角度を調整することで軽減できる場合があります。</li>
                    <li>治療後は普段どおりにお過ごしいただけますが、当日は激しい運動や飲酒は控えてください。</li>
                    <li><strong>週5回（月〜金）、計30回（約6週間）</strong>の治療が基本となります。</li>
                </ul>
            </div>
        </div>
        
        <div class="mt-5 text-center fw-bold">
            笠寺精治寮病院 rTMSセンター
        </div>
    </div>
</div>
{% endblock %}