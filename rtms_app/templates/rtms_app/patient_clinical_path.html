{% extends "rtms_app/base.html" %}

{% block extrastyle %}
<style>
    .calendar-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    
    .calendar-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .calendar-table th { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; text-align: center; color: #495057; width: 14.28%; }
    .calendar-table td { 
        border: 1px solid #dee2e6; padding: 5px; vertical-align: top; height: auto; min-height: 60px; 
        background-color: #fff; cursor: default; transition: background 0.1s;
    }
    .calendar-table td.clickable { cursor: pointer; }
    .calendar-table td.clickable:hover { background-color: #f8f9fa; }
    
    .day-sat { color: #007bff; background-color: #f8fbff !important; }
    .day-sun { color: #dc3545; background-color: #fff5f5 !important; }
    .day-holiday { color: #dc3545; background-color: #ffe8e8 !important; }
    
    .date-num { font-weight: bold; margin-bottom: 2px; display: block; font-size: 0.9rem; }
    
    /* イベントバッジ */
    .event-item { font-size: 0.75rem; margin-bottom: 2px; padding: 2px 4px; border-radius: 3px; display: block; line-height: 1.2; text-decoration: none; color: inherit; }
    .evt-admission { background-color: #cff4fc; color: #055160; border: 1px solid #b6effb; }
    .evt-mapping { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
    .evt-treatment { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
    .evt-assessment { background-color: #f8d7da; color: #842029; border: 1px solid #f5c6cb; font-weight: bold; }
    .evt-discharge { background-color: #0dcaf0; color: #fff; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }

    /* 右下固定ボタン */
    .floating-actions { position: fixed; bottom: 20px; right: 20px; z-index: 1050; display: flex; gap: 10px; }
    .btn-fab { border-radius: 30px; padding: 10px 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-weight: bold; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3><i class="fas fa-calendar-alt text-success"></i> 治療クリニカルパス (スケジュール)</h3>
        <div class="btn-group">
            <a href="{% url 'patient_print_path' patient.id %}" target="_blank" class="btn btn-primary">
                <i class="fas fa-print"></i> 印刷する (A4横)
            </a>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">戻る</a>
        </div>
    </div>

    <div class="calendar-container">
        <div class="calendar-header">
            <div>
                <h5 class="fw-bold mb-0">{{ patient.name }} 様</h5>
                <small class="text-muted">ID: {{ patient.card_id }} / 担当医: {% if patient.attending_physician %}{{ patient.attending_physician.last_name }} 先生{% endif %}</small>
            </div>
            <div class="text-end small">
                入院日: {{ patient.admission_date|default:"未定" }}<br>
                退院予定: {% if patient.discharge_date %}{{ patient.discharge_date }}{% else %}未定{% endif %}
            </div>
        </div>

        <div class="table-responsive">
            <table class="calendar-table">
                <thead>
                    <tr>
                        <th class="text-primary">月</th>
                        <th class="text-primary">火</th>
                        <th class="text-primary">水</th>
                        <th class="text-primary">木</th>
                        <th class="text-primary">金</th>
                        <th class="text-primary">土</th>
                        <th class="text-danger">日</th>
                    </tr>
                </thead>
                <tbody>
                    {% for week in calendar_weeks %}
                    <tr>
                        {% for day in week %}
                        <td class="{% if day.is_holiday %}day-holiday{% elif day.weekday == '土' %}day-sat{% elif day.weekday == '日' %}day-sun{% endif %} {% if day.url %}clickable{% endif %}"
                            {% if day.url %}onclick="window.location.href='{{ day.url }}'"{% endif %}>
                            
                            <span class="date-num">
                                {{ day.date|date:"n/j" }}
                                {% if day.is_holiday %}<span class="badge bg-danger ms-1" style="font-size: 0.6em;">祝</span>{% endif %}
                            </span>
                            
                            {% for event in day.events %}
                                {% if event.type == 'admission' %}
                                    <span class="event-item evt-admission"><i class="fas fa-procedures"></i> {{ event.label }}</span>
                                {% elif event.type == 'mapping' %}
                                    <span class="event-item evt-mapping"><i class="fas fa-crosshairs"></i> {{ event.label }}</span>
                                {% elif event.type == 'treatment' %}
                                    <span class="event-item evt-treatment"><i class="fas fa-bolt"></i> {{ event.label }}</span>
                                {% elif event.type == 'assessment' %}
                                    <span class="event-item evt-assessment"><i class="fas fa-clipboard-check"></i> {{ event.label }}</span>
                                {% elif event.type == 'discharge' %}
                                    <span class="event-item evt-discharge"><i class="fas fa-home"></i> {{ event.label }}</span>
                                {% endif %}
                            {% endfor %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="floating-actions">
    <a href="{% url 'patient_print_path' patient.id %}" target="_blank" class="btn btn-primary btn-fab text-white">
        <i class="fas fa-print"></i> 印刷する
    </a>
</div>
{% endblock %}