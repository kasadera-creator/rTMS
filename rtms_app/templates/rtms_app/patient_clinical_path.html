{% extends "rtms_app/base.html" %}
{% load static %}

{% block body_class %}page-admission{% endblock %}

{% block extrastyle %}
<style>
    .calendar-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    
    .calendar-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    .calendar-table th { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; text-align: center; color: #495057; width: 14.28%; }
    .calendar-table td { 
        border: 1px solid #dee2e6; padding: 5px; vertical-align: top; height: auto; min-height: 60px; 
        background-color: #fff; cursor: default; transition: background 0.1s;
    }
    .calendar-table td.clickable { cursor: pointer; }
    .calendar-table td.clickable:hover { background-color: #f8f9fa; }
    
    .day-sat { color: #007bff; background-color: #f8fbff !important; }
    .day-sun { color: #dc3545; background-color: #fff5f5 !important; }
    .day-holiday { color: #dc3545; background-color: #ffe8e8 !important; }
    
    .date-num { font-weight: bold; margin-bottom: 2px; display: block; font-size: 0.9rem; }
    
    /* イベントバッジ */
    .event-item { font-size: 0.75rem; margin-bottom: 2px; padding: 2px 4px; border-radius: 3px; display: block; line-height: 1.2; text-decoration: none; color: inherit; }
    /* 機能別テーマ */
    .evt-admission { background-color: var(--color-admission-bg); color: var(--color-admission); border: 1px solid var(--color-admission); }
    .evt-mapping { background-color: var(--color-mapping-bg); color: var(--color-mapping); border: 1px solid var(--color-mapping); }
    .evt-treatment { background-color: var(--color-treatment-bg); color: var(--color-treatment); border: 1px solid var(--color-treatment); }
    .evt-assessment { background-color: var(--color-assessment-bg); color: var(--color-assessment); border: 1px solid var(--color-assessment); font-weight: bold; }
    .evt-discharge { background-color: var(--color-discharge-bg); color: var(--color-discharge); border: 1px solid var(--color-discharge); font-weight: bold; }

</style>
{% endblock %}

{% block content %}
<form id="mainForm" class="d-none" method="get"></form>
<div class="container py-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="d-flex align-items-center gap-2 mb-0"><i class="fas fa-calendar-alt page-title-icon"></i> クリニカルパス (スケジュール) {% include "rtms_app/partials/recommendation_badge.html" %}</h3>
        {% include "rtms_app/partials/patient_nav.html" %}
    </div>

    {% if recommendation and recommendation.status != 'pending' %}
    <div class="alert {% if recommendation.status == 'remission' %}alert-success{% elif recommendation.status == 'ineffective' %}alert-danger{% else %}alert-info{% endif %} fw-bold">
        <i class="fas fa-bullhorn me-1"></i>{{ recommendation.message }}
        <div class="small fw-normal mt-1">{{ recommendation.detail }}</div>
    </div>
    {% endif %}

    <div class="calendar-container">
        <div class="calendar-header">
            <div>
                <h5 class="fw-bold mb-0">{{ patient.name }} 様</h5>
                <small class="text-muted">ID: {{ patient.card_id }} / 担当医: {% if patient.attending_physician %}{{ patient.attending_physician.last_name }} 先生{% endif %}</small>
            </div>
            <div class="text-end small">
                入院日: {{ patient.admission_date|default:"未定" }}<br>
                退院予定: {% if patient.discharge_date %}{{ patient.discharge_date }}{% else %}未定{% endif %}
            </div>
        </div>

        <div class="mb-4">
            <h5>評価結果</h5>
            {% for event in assessment_events %}
                {% if event.timing == 'baseline' %}
                    <p>評価（治療前）: {% if event.label|slice:"-4:" == "(済)" %}完了{% else %}未実施{% endif %}</p>
                {% elif event.timing == 'week3' %}
                    <p>評価（第3週目）: {% if event.label|slice:"-4:" == "(済)" %}完了{% else %}未実施{% endif %}</p>
                {% elif event.timing == 'week6' %}
                    <p>評価（第4週目）: {% if event.label|slice:"-4:" == "(済)" %}完了{% else %}未実施{% endif %}</p>
                {% endif %}
            {% endfor %}
        </div>

        <div class="table-responsive">
            <table class="calendar-table">
                <thead>
                    <tr>
                        <th class="text-primary">月</th>
                        <th class="text-primary">火</th>
                        <th class="text-primary">水</th>
                        <th class="text-primary">木</th>
                        <th class="text-primary">金</th>
                        <th class="text-primary">土</th>
                        <th class="text-danger">日</th>
                    </tr>
                </thead>
                <tbody>
                    {% for week in calendar_weeks %}
                    <tr>
                        {% for day in week %}
                        <td class="{% if day.is_holiday %}day-holiday{% elif day.weekday == '土' %}day-sat{% elif day.weekday == '日' %}day-sun{% endif %} {% if day.url %}clickable{% endif %}"
                            {% if day.url %}onclick="window.location.href='{{ day.url }}'"{% endif %}
                            data-date="{{ day.date|date:'Y-m-d' }}">
                            
                            <span class="date-num">
                                {{ day.date|date:"n/j" }}
                                {% if day.is_holiday %}<span class="badge bg-danger ms-1" style="font-size: 0.6em;">祝</span>{% endif %}
                            </span>
                            
                            {% for event in day.events %}
                                {% if event.type == 'admission' %}
                                    <a href="{{ event.url }}" class="event-item evt-admission" onclick="event.stopPropagation();"><i class="fas fa-procedures"></i> {{ event.label }}</a>
                                {% elif event.type == 'mapping' %}
                                    <a href="{{ event.url }}" class="event-item evt-mapping" onclick="event.stopPropagation();"><i class="fas fa-crosshairs"></i> {{ event.label }}</a>
                                {% elif event.type == 'treatment' %}
                                    <a href="{{ event.url }}" class="event-item evt-treatment" onclick="event.stopPropagation();"><i class="fas fa-bolt"></i> {{ event.label }}</a>
                                {% elif event.type == 'assessment' %}
                                    <a href="{{ event.url }}" class="event-item evt-assessment" onclick="event.stopPropagation();"><i class="fas fa-clipboard-check"></i> {{ event.label }}</a>
                                {% elif event.type == 'discharge' %}
                                    <a href="{{ event.url }}" class="event-item evt-discharge" onclick="event.stopPropagation();"><i class="fas fa-home"></i> {{ event.label }}</a>
                                {% endif %}
                            {% endfor %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% url 'rtms_app:dashboard' as dashboard_url %}
{% if dashboard_date %}
    {% with back_url=dashboard_url|add:"?date="|add:dashboard_date %}
        <link rel="stylesheet" href="{% static 'rtms_app/floating.css' %}">
        <script src="{% static 'rtms_app/floating.js' %}"></script>

        <div class="fab-stack no-print">
            {% if floating_print_options and floating_print_options.0.href %}
                <button type="button" class="btn btn-primary fab" onclick="window.open('{{ floating_print_options.0.href|escapejs }}', '{{ floating_print_options.0.target|default:"_blank" }}');">
                    <i class="fas fa-print"></i> 印刷プレビュー
                </button>
            {% endif %}

            <a class="btn btn-secondary fab" href="{{ back_url }}">
                <i class="fas fa-undo"></i> 戻る
            </a>
        </div>
    {% endwith %}
{% else %}
    <link rel="stylesheet" href="{% static 'rtms_app/floating.css' %}">
    <script src="{% static 'rtms_app/floating.js' %}"></script>

    <div class="fab-stack no-print">
        {% if floating_print_options and floating_print_options.0.href %}
            <a class="btn btn-primary fab" href="{{ floating_print_options.0.href }}" {% if floating_print_options.0.target %}target="{{ floating_print_options.0.target }}"{% endif %}>
                <i class="fas fa-print"></i> 印刷プレビュー
            </a>
        {% endif %}

        <a class="btn btn-patient-list fab" href="{{ dashboard_url }}">
            <i class="fas fa-undo"></i> 戻る
        </a>
    </div>
{% endif %}

    <div class="my-4">
        {% include 'rtms_app/partials/print_box.html' %}
    </div>

{% endblock %}

{% block scripts %}
<script>
  window.addEventListener("load", function() {
    const params = new URLSearchParams(window.location.search);
    const focus = params.get("focus");
    if (!focus) return;
    const el = document.querySelector(`[data-date="${focus}"]`);
    if (el) el.scrollIntoView({behavior:"smooth", block:"center"});
  });
</script>
{% endblock %}