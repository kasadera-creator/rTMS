{% extends "rtms_app/base.html" %}
{% block extrastyle %}
<style>
    textarea { width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 10px; resize: vertical; }
    .history-table th { background-color: #f8f9fa; text-align: center; white-space: nowrap; }
    .history-table td { text-align: center; vertical-align: middle; }
    .score-table th { background-color: #e8f5e9; text-align: center; font-size: 0.9rem; }
    .score-table td { text-align: center; font-size: 0.9rem; }
    .fixed-bottom-bar { background: rgba(255,255,255,0.9); border-top: 1px solid #ddd; padding: 15px; position: fixed; bottom: 0; left: 0; width: 100%; z-index: 1000; text-align: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 mb-5">
    <!-- ヘッダー -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3><i class="fas fa-file-alt"></i> サマリー・紹介状作成</h3>
        <div class="btn-group">
            <a href="{% url 'patient_print_summary' patient.id %}?mode=summary" target="_blank" class="btn btn-outline-primary">
                <i class="fas fa-print"></i> 退院サマリー印刷
            </a>
            <a href="{% url 'patient_print_summary' patient.id %}?mode=referral" target="_blank" class="btn btn-outline-success">
                <i class="fas fa-envelope"></i> 紹介状印刷
            </a>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">戻る</a>
        </div>
    </div>

    <!-- メインエリア: フォームで囲む -->
    <form method="post" class="bg-white p-4 shadow-sm rounded">
        {% csrf_token %}
        
        <!-- 1. 患者情報ヘッダー -->
        <div class="alert alert-light border mb-4">
            <div class="row">
                <div class="col-md-3"><strong>ID:</strong> {{ patient.card_id }}</div>
                <div class="col-md-3"><strong>氏名:</strong> {{ patient.name }}</div>
                <div class="col-md-3">
                    <strong>担当医:</strong> 
                    {% if patient.attending_physician %}
                        {{ patient.attending_physician.last_name }} {{ patient.attending_physician.first_name }}
                    {% else %}
                        未定
                    {% endif %}
                </div>
                <div class="col-md-3"><strong>入院:</strong> {{ patient.admission_date|default:"-" }}</div>
            </div>
        </div>

        <!-- 2. サマリー入力 -->
        <div class="mb-4">
            <label class="form-label fw-bold">入院経過・治療結果（サマリー本文）</label>
            <textarea name="summary_text" rows="10" class="form-control">{{ summary_text }}</textarea>
            <div class="form-text text-muted">
                ※内容は編集可能です。下部の「保存」ボタンで保存してください。
            </div>
        </div>

        <!-- 3. 退院時処方 (新規追加) -->
        <div class="mb-4">
            <label class="form-label fw-bold text-primary">退院時処方</label>
            <textarea name="discharge_prescription" rows="4" class="form-control" placeholder="退院時の処方内容を入力してください...">{{ patient.discharge_prescription }}</textarea>
        </div>

        <hr>

        <!-- 4. 治療実施履歴 -->
        <div class="mt-4">
            <h6 class="fw-bold border-bottom pb-2">rTMS 治療実施記録</h6>
            <div style="max-height: 300px; overflow-y: auto;">
                <table class="table table-bordered history-table table-sm">
                    <thead><tr><th>回数</th><th>日付</th><th>MT(%)</th><th>強度(%)</th><th>備考・副作用</th></tr></thead>
                    <tbody>
                        {% for item in history_list %}
                        <tr>
                            <td>{{ item.count }}</td>
                            <td>{{ item.date|date:"Y/n/j" }}</td>
                            <td>{{ item.mt }}</td>
                            <td>{{ item.intensity }}</td>
                            <td class="text-start">{{ item.se }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5">記録がありません</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 5. 心理検査推移 -->
        <div class="mt-4">
            <h6 class="fw-bold border-bottom pb-2 text-success"><i class="fas fa-chart-line"></i> 心理検査推移 (HAMD)</h6>
            <div style="overflow-x: auto;">
                <table class="table table-sm table-striped score-table w-auto">
                    <thead>
                        <tr>
                            <th style="min-width:120px;">実施日</th>
                            <th style="min-width:100px;">HAMD 17項</th>
                            <th style="min-width:100px;">HAMD 21項</th>
                            <th style="min-width:100px;">時期</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for score in test_scores %}
                        <tr>
                            <td>{{ score.date|date:"Y/n/j" }}</td>
                            <td class="fw-bold">{{ score.total_score_17 }}</td>
                            <td>{{ score.total_score_21 }}</td>
                            <td>{{ score.get_timing_display|default:"-" }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="4" class="text-muted py-3">データなし</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 固定フッター保存ボタン -->
        <div class="fixed-bottom-bar">
            <button type="submit" class="btn btn-primary px-5 fw-bold shadow">
                <i class="fas fa-save"></i> 内容を保存する
            </button>
        </div>
        <div style="height: 50px;"></div>
    </form>
</div>
{% endblock %}