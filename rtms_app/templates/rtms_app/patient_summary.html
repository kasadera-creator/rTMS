{% extends "rtms_app/base.html" %}
{% load static %}
{% block body_class %}
  page-discharge
{% endblock body_class %}
{% block header_breadcrumb %}
  <span class="text-white-50 ms-2">/ 退院準備</span>
{% endblock header_breadcrumb %}
{% block extrastyle %}
  <style>
    .section-title {
        border-left: 5px solid var(--color-discharge);
        padding-left: 10px;
        margin-bottom: 1.5rem;
    }
    textarea { width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 10px; resize: vertical; }
    .history-table th { background-color: #f8f9fa; text-align: center; white-space: nowrap; }
    .history-table td { text-align: center; vertical-align: middle; }
    .score-table th { background-color: #f3e5f5; text-align: center; font-size: 0.9rem; }
    .score-table td { text-align: center; font-size: 0.9rem; }

    .discharge-date-card { border-left: 5px solid var(--color-discharge); background-color: #faf5ff; }

    .autosave-toast {
        position: fixed;
        right: 16px;
        bottom: 16px;
        min-width: 260px;
        z-index: 1100;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
  </style>
{% endblock extrastyle %}
{% block content %}
  <div class="container py-4 mb-5">
    <!-- ヘッダー: 患者メニュー -->
    {% include "rtms_app/partials/patient_inline_bar.html" with page_title="治療経過・退院準備" title_icon="fa-file-alt" patient=patient %}
    {% if recommendation and recommendation.status != 'pending' %}
      <div class="alert {% if recommendation.status == 'remission' %}alert-success{% elif recommendation.status == 'ineffective' %}alert-danger{% else %}alert-info{% endif %} fw-bold">
        <i class="fas fa-bullhorn me-1"></i>{{ recommendation.message }}
        <div class="small fw-normal mt-1">{{ recommendation.detail }}</div>
      </div>
    {% endif %}
    <form method="post" id="mainForm" data-disable-floating-autosave="true">
      {% csrf_token %}
      <div class="row g-3">
        <div class="col-12">
          <div class="card discharge-date-card shadow-sm">
            <div class="card-body py-3 d-flex align-items-center">
              <div class="me-3">
                <label class="fw-bold mb-0"
                       style="font-size: 1.05rem;
                              color: var(--color-discharge)">
                  <i class="fas fa-calendar-check me-2"></i>退院日設定
                </label>
              </div>
              <div class="me-3" style="min-width:160px;">
                <input type="date"
                       name="discharge_date"
                       id="dischargeDateInput"
                       class="form-control fw-bold"
                       value="{{ patient.discharge_date|date:'Y-m-d' }}">
              </div>
              <div class="flex-fill">
                <span class="text-muted small">※退院日が決まったら設定してください。入力すると下のサマリー本文に自動反映されます。</span>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12">
          <div class="card shadow-sm mb-3">
            <div class="card-header card-header-accent d-flex align-items-center justify-content-between" style="--card-accent: var(--color-discharge-dark); background: var(--color-discharge-bg); color: var(--color-discharge-dark);">
              <div class="fw-bold">
                <i class="fas fa-file-medical-alt me-2 text-muted"></i>入院経過・治療結果（サマリー本文）
              </div>
            </div>
            <div class="card-body">
              <textarea name="summary_text" id="summaryText" rows="10" class="form-control">{{ summary_text }}</textarea>
              <div class="form-text text-muted mt-2">※内容は編集可能です。</div>
            </div>
          </div>
          <div class="card mt-3 shadow-sm">
            <div class="card-header card-header-accent fw-bold" style="--card-accent: var(--color-discharge-dark); background: var(--color-discharge-bg); color: var(--color-discharge-dark);">退院時処方</div>
            <div class="card-body">
              <textarea name="discharge_prescription"
                        rows="4"
                        class="form-control"
                        placeholder="退院時の処方内容を入力してください...">{{ patient.discharge_prescription }}</textarea>
            </div>
          </div>
        </div>
        <!-- right column removed: summary/status and quick actions were redundant -->
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header card-header-accent fw-bold" style="--card-accent: var(--color-discharge-dark); background: var(--color-discharge-bg); color: var(--color-discharge-dark);">rTMS 治療実施記録</div>
            <div class="card-body p-2" style="max-height: 320px; overflow-y: auto;">
              <table class="table table-bordered history-table table-sm mb-0">
                <thead>
                  <tr>
                    <th>回数</th>
                    <th>日付</th>
                    <th>MT（%）</th>
                    <th>出力（%）</th>
                    <th>周波数(Hz)</th>
                    <th>刺激時間(s)</th>
                    <th>非刺激時間(s)</th>
                    <th>トレイン回数</th>
                    <th>備考・副作用</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in history_list %}
                    <tr>
                      <td class="text-center">{{ item.count }}</td>
                      <td class="text-center">{{ item.date|date:"Y/n/j" }}</td>
                      <td class="text-center">{{ item.mt }}</td>
                      <td class="text-center">
                        {% if item.output_pct is not None %}
                          {{ item.output_pct }}
                        {% else %}
                          -
                        {% endif %}
                      </td>
                      <td class="text-center">{{ item.frequency_hz|default:18 }}</td>
                      <td class="text-center">{{ item.train_seconds|default:2 }}</td>
                      <td class="text-center">{{ item.intertrain_seconds|default:20 }}</td>
                      <td class="text-center">{{ item.train_count|default:55 }}</td>
                      <td class="text-start">{{ item.se }}</td>
                    </tr>
                  {% empty %}
                    <tr>
                      <td colspan="9">記録がありません</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header card-header-accent fw-bold" style="--card-accent: var(--color-discharge-dark); background: var(--color-discharge-bg); color: var(--color-discharge-dark);">
              <i class="fas fa-chart-line me-2"></i>心理検査推移 (HAMD)
            </div>
            <div class="card-body" style="overflow-x: auto;">
              <table class="table table-sm table-striped score-table w-auto mb-0">
                <thead>
                  <tr>
                    <th style="min-width:140px;">項目</th>
                    {% for c in trend_cols %}
                      <th style="min-width:120px;">
                        {{ c.label }}
                        <div class="small text-muted">{{ c.date_str }}</div>
                      </th>
                    {% endfor %}
                  </tr>
                </thead>
                <tbody>
                  {% if trend_cols %}
                    <tr>
                      <td class="fw-bold">HAMD 21項</td>
                      {% for c in trend_cols %}
                        <td class="fw-bold">
                          {% if c.hamd21 is not None %}
                            {{ c.hamd21 }}
                          {% else %}
                            -
                          {% endif %}
                        </td>
                      {% endfor %}
                    </tr>
                    <tr>
                      <td class="fw-bold">HAMD 17項</td>
                      {% for c in trend_cols %}
                        <td>
                          {% if c.hamd17 is not None %}
                            {{ c.hamd17 }}
                          {% else %}
                            -
                          {% endif %}
                        </td>
                      {% endfor %}
                    </tr>
                    <tr>
                      <td class="fw-bold">改善率（HAMD17）</td>
                      {% for c in trend_cols %}
                        <td>
                          {% if c.improvement_pct is not None %}
                            {{ c.improvement_pct }}%
                          {% else %}
                            -
                          {% endif %}
                        </td>
                      {% endfor %}
                    </tr>
                  {% else %}
                    <tr>
                      <td colspan="5" class="text-muted py-3">データなし</td>
                    </tr>
                  {% endif %}
                </tbody>
              </table>
              <div class="mt-2 p-2 bg-light border rounded small text-muted">
                <strong>※HAMD17 参考基準:</strong> 0-7:正常 | 8-13:軽症 | 14-18:中等症 | 19-22:重症 | 23-:最重症
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
    <div class="form-section">
      <div class="card mb-3">
        <div class="card-header card-header-accent fw-bold" style="--card-accent: var(--color-discharge-dark); background: var(--color-discharge-bg); color: var(--color-discharge-dark);">退院時 印刷・書類</div>
        <div class="card-body">
          <div class="small text-muted mb-3">各ドキュメントを個別に印刷・保存できます</div>
          <div class="d-grid gap-2">
            <a class="btn btn-primary btn-sm" href="{% url 'rtms_app:print:patient_print_discharge' patient.id %}" target="_blank" rel="noopener">
              <i class="fas fa-print"></i> 退院時サマリーを印刷
            </a>
            <a class="btn btn-primary btn-sm" href="{% url 'rtms_app:print:patient_print_referral' patient.id %}" target="_blank" rel="noopener">
              <i class="fas fa-print"></i> 紹介状を印刷
            </a>
          </div>
        </div>
      </div>
    </div>
    {% url 'rtms_app:dashboard' as dashboard_url %}
    {% if dashboard_date %}
      {% with back_url=dashboard_url|add:"?date="|add:dashboard_date %}
        <link rel="stylesheet" href="{% static 'rtms_app/floating.css' %}">
        <script src="{% static 'rtms_app/floating.js' %}"></script>
        <div class="fab-stack no-print">
          <a class="btn btn-primary fab" href="{% url 'rtms_app:print:patient_print_discharge' patient.id %}" target="_blank">
            <i class="fas fa-file-pdf"></i> 退院時
          </a>
          <a class="btn btn-primary fab" href="{% url 'rtms_app:print:patient_print_referral' patient.id %}" target="_blank">
            <i class="fas fa-file-pdf"></i> 紹介状
          </a>
          <button type="button"
                  class="btn btn-discharge fab"
                  onclick="RTMSFloating.submitFormById('mainForm')">
            <i class="fas fa-save"></i> 保存
          </button>
          <a class="btn btn-secondary fab" href="{{ back_url }}">
            <i class="fas fa-undo"></i> 戻る
          </a>
        </div>
      {% endwith %}
    {% else %}
      <link rel="stylesheet" href="{% static 'rtms_app/floating.css' %}">
      <script src="{% static 'rtms_app/floating.js' %}"></script>
      <div class="fab-stack no-print">
        <a class="btn btn-primary fab" href="{% url 'rtms_app:print:patient_print_discharge' patient.id %}" target="_blank">
          <i class="fas fa-file-pdf"></i> 退院時
        </a>
        <a class="btn btn-primary fab" href="{% url 'rtms_app:print:patient_print_referral' patient.id %}" target="_blank">
          <i class="fas fa-file-pdf"></i> 紹介状
        </a>
        <button type="button"
                class="btn btn-discharge fab"
                onclick="RTMSFloating.submitFormById('mainForm')">
          <i class="fas fa-save"></i> 保存
        </button>
        <a class="btn btn-secondary fab" href="{{ dashboard_url }}">
          <i class="fas fa-undo"></i> 戻る
        </a>
      </div>
    {% endif %}
  </div>
  <div id="autosaveToast"
       class="toast align-items-center text-white bg-success autosave-toast"
       role="status"
       aria-live="polite">
    <div class="d-flex">
      <div class="toast-body" id="autosaveToastBody">✓ 自動保存しました</div>
      <button type="button"
              class="btn-close btn-close-white me-2 m-auto"
              aria-label="Close"
              onclick="hideToast()"></button>
    </div>
  </div>
  <script>
    document.getElementById('dischargeDateInput').addEventListener('change', function(e) {
        const dateVal = e.target.value;
        if (!dateVal) return;
        const d = new Date(dateVal);
        const formattedDate = `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日`;
        const textarea = document.getElementById('summaryText');
        let text = textarea.value;
        const regex = /(\d{4}年\d{1,2}月\d{1,2}日|未定)退院/;
        if (text.match(regex)) {
            const newText = text.replace(regex, `${formattedDate}退院`);
            textarea.value = newText;
            textarea.style.backgroundColor = "#e6f9ed";
            setTimeout(() => { textarea.style.backgroundColor = ""; }, 500);
        }
    });

  </script>
  <script>
  const autosaveToast = document.getElementById('autosaveToast');
  const autosaveToastBody = document.getElementById('autosaveToastBody');
  let autosaveTimer = null;

  function showToast(message, variant = 'success') {
    autosaveToastBody.textContent = message;
    autosaveToast.classList.remove('bg-success', 'bg-danger');
    autosaveToast.classList.add(variant === 'error' ? 'bg-danger' : 'bg-success');
    autosaveToast.style.display = 'block';
    const bsToast = bootstrap.Toast.getOrCreateInstance(autosaveToast, { delay: 2500 });
    bsToast.show();
  }

  function hideToast() {
    const bsToast = bootstrap.Toast.getOrCreateInstance(autosaveToast);
    bsToast.hide();
  }

  async function performSave(action = '') {
    const form = document.getElementById('mainForm');
    const fd = new FormData(form);
    if (action) {
      fd.append('action', action);
    }

    const res = await fetch(window.location.href, {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
      body: fd,
      credentials: 'same-origin',
    });

    if (!res.ok) {
      throw new Error(`save failed: HTTP ${res.status}`);
    }

    const data = await res.json();
    if (!action) {
      showToast('✓ 自動保存しました');
    }
    return data;
  }

  function debounceSave() {
    if (autosaveTimer) {
      clearTimeout(autosaveTimer);
    }
    autosaveTimer = setTimeout(() => {
      performSave().catch((err) => {
        console.error(err);
        showToast('保存に失敗しました', 'error');
      });
    }, 1000);
  }

  document.querySelectorAll('#mainForm input, #mainForm textarea').forEach((el) => {
    el.addEventListener('input', debounceSave);
    el.addEventListener('change', debounceSave);
  });
  </script>
{% endblock content %}
