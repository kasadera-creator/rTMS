{% extends "rtms_app/base.html" %}
{% block extrastyle %}
<style>
    textarea { width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 10px; resize: vertical; }
    .history-table th { background-color: #f8f9fa; text-align: center; white-space: nowrap; }
    .history-table td { text-align: center; vertical-align: middle; }
    .score-table th { background-color: #e8f5e9; text-align: center; font-size: 0.9rem; }
    .score-table td { text-align: center; font-size: 0.9rem; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3><i class="fas fa-file-alt"></i> サマリー・紹介状作成</h3>
        <div class="btn-group">
            <a href="{% url 'patient_print_summary' patient.id %}?mode=summary" target="_blank" class="btn btn-outline-primary">
                <i class="fas fa-print"></i> 退院サマリー印刷
            </a>
            <a href="{% url 'patient_print_summary' patient.id %}?mode=referral" target="_blank" class="btn btn-outline-success">
                <i class="fas fa-envelope"></i> 紹介状形式で印刷
            </a>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">戻る</a>
        </div>
    </div>

    <div class="bg-white p-4 shadow-sm rounded">
        <div class="alert alert-light border mb-4">
            <div class="row">
                <div class="col-md-3"><strong>ID:</strong> {{ patient.card_id }}</div>
                <div class="col-md-3"><strong>氏名:</strong> {{ patient.name }}</div>
                <div class="col-md-3"><strong>担当医:</strong> {{ patient.attending_physician }}</div>
                <div class="col-md-3"><strong>入院:</strong> {{ patient.admission_date|default:"-" }}</div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="mb-3">
                    <label class="form-label fw-bold">入院経過・治療結果（サマリー本文）</label>
                    <textarea name="summary_text" rows="12" class="form-control">{{ summary_text }}</textarea>
                    <div class="form-text text-muted">
                        ※現在は自動生成されたテキストが表示されています。
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <label class="form-label fw-bold text-success"><i class="fas fa-chart-line"></i> 心理検査推移 (HAMD)</label>
                <div class="card border-success mb-3">
                    <div class="card-body p-0">
                        <table class="table table-sm table-striped score-table mb-0">
                            <thead>
                                <tr>
                                    <th>実施日</th>
                                    <th>17項</th>
                                    <th>21項</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for score in test_scores %}
                                <tr>
                                    <td>{{ score.date|date:"n/j" }}</td>
                                    <td class="fw-bold">{{ score.total_score_17 }}</td>
                                    <td>{{ score.total_score_21 }}</td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="3" class="text-muted py-3">データなし</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="text-muted small">
                    <i class="fas fa-info-circle"></i> 最新の評価結果を参照してサマリーを作成してください。
                </div>
            </div>
        </div>

        <hr>

        <div class="mt-4">
            <h6 class="fw-bold border-bottom pb-2">rTMS 治療実施記録</h6>
            <div style="max-height: 300px; overflow-y: auto;">
                <table class="table table-bordered history-table table-sm">
                    <thead><tr><th>回数</th><th>日付</th><th>MT(%)</th><th>強度(%)</th><th>備考・副作用</th></tr></thead>
                    <tbody>
                        {% for item in history_list %}
                        <tr>
                            <td>{{ item.count }}</td>
                            <td>{{ item.date|date:"Y/n/j" }}</td>
                            <td>{{ item.mt }}</td>
                            <td>{{ item.intensity }}</td>
                            <td class="text-start">{{ item.se }}</td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5">記録がありません</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}