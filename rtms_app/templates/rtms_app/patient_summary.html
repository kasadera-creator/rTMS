{% extends "rtms_app/base.html" %}
{% block extrastyle %}
<style>
    textarea { width: 100%; border: 1px solid #ced4da; border-radius: 4px; padding: 10px; resize: vertical; }
    .history-table th { background-color: #f8f9fa; text-align: center; white-space: nowrap; }
    .history-table td { text-align: center; vertical-align: middle; }
    .score-table th { background-color: #e8f5e9; text-align: center; font-size: 0.9rem; }
    .score-table td { text-align: center; font-size: 0.9rem; }
    
    .floating-actions { position: static; display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; margin-top: 24px; }
    .btn-fab { border-radius: 30px; padding: 10px 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); font-weight: bold; width: fit-content; }
    .discharge-date-card { border-left: 5px solid #17a2b8; background-color: #f0fdf4; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4 mb-5">
    <!-- ヘッダー: 患者メニュー -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3><i class="fas fa-file-alt"></i> サマリー・紹介状作成</h3>
        <div class="btn-group">
            <a href="{% url 'rtms_app:patient_first_visit' patient.id %}{% if dashboard_date %}?dashboard_date={{ dashboard_date }}{% endif %}" class="btn btn-outline-secondary btn-sm">基本情報</a>
            <a href="{% url 'rtms_app:patient_clinical_path' patient.id %}" target="_blank" class="btn btn-outline-success btn-sm">パス表示</a>
            <!-- 印刷ボタンは別途フローティングにもあるが、ここにも配置可 -->
            <a href="{% url 'rtms_app:dashboard' %}{% if dashboard_date %}?date={{ dashboard_date }}{% endif %}" class="btn btn-secondary btn-sm">戻る</a>
        </div>
    </div>

    <!-- (以下、フォーム部分は既存と同じ) -->
    <form method="post" id="summaryForm" class="bg-white p-4 shadow-sm rounded">
        {% csrf_token %}
        <div class="alert alert-light border mb-4">
            <div class="row align-items-center">
                <div class="col-md-3"><strong>ID:</strong> {{ patient.card_id }}</div>
                <div class="col-md-3"><strong>氏名:</strong> {{ patient.name }}</div>
                <div class="col-md-3">
                    <strong>担当医:</strong> 
                    {% if patient.attending_physician %}
                        {{ patient.attending_physician.last_name }} {{ patient.attending_physician.first_name }}
                    {% else %}
                        未定
                    {% endif %}
                </div>
                <div class="col-md-3"><strong>入院日:</strong> {{ patient.admission_date|default:"-" }}</div>
            </div>
        </div>

        <div class="card discharge-date-card mb-4 shadow-sm">
            <div class="card-body py-3">
                <div class="row align-items-center">
                    <div class="col-md-auto"><label class="fw-bold text-info mb-0" style="font-size: 1.1rem;"><i class="fas fa-calendar-check me-2"></i>退院日設定</label></div>
                    <div class="col-md-auto"><input type="date" name="discharge_date" id="dischargeDateInput" class="form-control fw-bold" value="{{ patient.discharge_date|date:'Y-m-d' }}"></div>
                    <div class="col"><span class="text-muted small">※退院日が決まったら設定してください。入力すると下のサマリー本文に自動反映されます。</span></div>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <label class="form-label fw-bold">入院経過・治療結果（サマリー本文）</label>
            <textarea name="summary_text" id="summaryText" rows="10" class="form-control">{{ summary_text }}</textarea>
            <div class="form-text text-muted">※内容は編集可能です。印刷ボタンを押すと自動保存されます。</div>
        </div>

        <div class="mb-4">
            <label class="form-label fw-bold text-primary">退院時処方</label>
            <textarea name="discharge_prescription" rows="4" class="form-control" placeholder="退院時の処方内容を入力してください...">{{ patient.discharge_prescription }}</textarea>
        </div>

        <hr>

        <div class="mt-4">
            <h6 class="fw-bold border-bottom pb-2">rTMS 治療実施記録</h6>
            <div style="max-height: 300px; overflow-y: auto;">
                <table class="table table-bordered history-table table-sm">
                    <thead><tr><th>回数</th><th>日付</th><th>MT(%)</th><th>強度(%)</th><th>備考・副作用</th></tr></thead>
                    <tbody>
                        {% for item in history_list %}
                        <tr>
                            <td>{{ item.count }}</td><td>{{ item.date|date:"Y/n/j" }}</td>
                            <td>{{ item.mt }}</td><td>{{ item.intensity }}</td>
                            <td class="text-start">{{ item.se }}</td>
                        </tr>
                        {% empty %}<tr><td colspan="5">記録がありません</td></tr>{% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="mt-4">
            <h6 class="fw-bold border-bottom pb-2 text-success"><i class="fas fa-chart-line"></i> 心理検査推移 (HAMD)</h6>
            <div style="overflow-x: auto;">
                <table class="table table-sm table-striped score-table w-auto">
                    <thead><tr><th style="min-width:120px;">実施日</th><th style="min-width:100px;">時期</th><th style="min-width:100px;">HAMD 17項</th><th style="min-width:100px;">HAMD 21項</th></tr></thead>
                    <tbody>
                        {% for score in test_scores %}
                        <tr>
                            <td>{{ score.date|date:"Y/n/j" }}</td><td>{{ score.get_timing_display|default:"-" }}</td>
                            <td class="fw-bold">{{ score.total_score_17 }}</td><td>{{ score.total_score_21 }}</td>
                        </tr>
                        {% empty %}<tr><td colspan="4" class="text-muted py-3">データなし</td></tr>{% endfor %}
                    </tbody>
                </table>
                <div class="mt-2 p-2 bg-light border rounded small text-muted"><strong>※HAMD17 参考基準:</strong> 0-7:正常 | 8-13:軽症 | 14-18:中等症 | 19-22:重症 | 23-:最重症</div>
            </div>
        </div>

        <div style="height: 50px;"></div>

        <div class="floating-actions">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-primary btn-fab" onclick="saveAndPrint('discharge')"><i class="fas fa-print"></i> 退院サマリー 印刷</button>
                <button type="button" class="btn btn-success btn-fab" onclick="saveAndPrint('referral')"><i class="fas fa-envelope"></i> 紹介状 印刷</button>
            </div>
            <button type="submit" class="btn btn-dark btn-fab"><i class="fas fa-save"></i> 保存して終了</button>
            <a href="{% url 'rtms_app:dashboard' %}{% if dashboard_date %}?date={{ dashboard_date }}{% endif %}" class="btn btn-secondary btn-fab"><i class="fas fa-undo"></i> 戻る</a>
        </div>
    </form>
</div>

<script>
    document.getElementById('dischargeDateInput').addEventListener('change', function(e) {
        const dateVal = e.target.value; 
        if (!dateVal) return;
        const d = new Date(dateVal);
        const formattedDate = `${d.getFullYear()}年${d.getMonth() + 1}月${d.getDate()}日`;
        const textarea = document.getElementById('summaryText');
        let text = textarea.value;
        const regex = /(\d{4}年\d{1,2}月\d{1,2}日|未定)退院/;
        if (text.match(regex)) {
            const newText = text.replace(regex, `${formattedDate}退院`);
            textarea.value = newText;
            textarea.style.backgroundColor = "#e6f9ed";
            setTimeout(() => { textarea.style.backgroundColor = ""; }, 500);
        }
    });

    function saveAndPrint(mode) {
        const form = document.getElementById('summaryForm');
        const formData = new FormData(form);
        const url = window.location.href;

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
        })
        .then(response => {
            if (response.ok) {
                const printUrls = {
                    discharge: "{% url 'rtms_app:patient_print_discharge' patient.id %}",
                    referral: "{% url 'rtms_app:patient_print_referral' patient.id %}",
                };
                const printUrl = printUrls[mode];
                if (printUrl) { window.open(printUrl, '_blank'); }
            } else { alert('保存に失敗しました。'); }
        })
        .catch(error => { console.error('Error:', error); alert('通信エラーが発生しました。'); });
    }
</script>
{% endblock %}