{% extends "rtms_app/patient/base_patient.html" %}

{% block header_right %}
  {{ block.super }}
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="portal-card shadow-sm">
    <div class="d-flex flex-column gap-3">
      {# 1) 入力途中があれば最優先で再開導線 #}
      {% if in_progress_session %}
        <div>
          <div class="text-uppercase text-muted small fw-bold">自己記入式検査（入力途中）</div>
          <h1 class="h4 fw-bold mb-0">{{ patient.name }} さん</h1>
          <p class="text-muted small mb-2">自己記入式検査は現在、入力途中です。前回の続きから検査を再開できます。</p>
          <p class="text-muted small mb-0">スタッフが内容を確認のうえ、「検査を再開する」ボタンを押してください。</p>
        </div>
        <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
          <a class="btn btn-primary btn-lg px-4" href="{% url 'patient_portal:instrument' in_progress_session.id instrument_order.0 %}"><i class="fas fa-play me-2"></i>検査を再開する</a>
          <span class="text-muted small">{{ in_progress_session.get_phase_display }} / {{ in_progress_session.started_at|date:"Y/m/d H:i" }}</span>
        </div>
      {# 2) 全フェーズ完了済みなら完了表示 #}
      {% elif latest_pre and latest_pre.status == "submitted" and latest_post and latest_post.status == "submitted" %}
        <div>
          <div class="text-uppercase text-muted small fw-bold">自己記入式検査は完了しています</div>
          <h1 class="h4 fw-bold mb-0">{{ patient.name }} さん</h1>
          <p class="text-muted small mb-2">自己記入式検査は、すでにすべて完了しています。ご協力ありがとうございました。</p>
          <p class="text-muted small mb-0">この内容は医師・スタッフが確認します。次のご案内があるまで、この画面のままお待ちください。</p>
        </div>
        <div class="d-flex flex-wrap align-items-center gap-3 mb-3">
          <a class="btn btn-outline-secondary" href="{% url 'patient_portal:review' latest_pre.id %}"><i class="fas fa-eye me-2"></i>内容を確認する（閲覧のみ）</a>
        </div>
      {# 3) 開始/再実施導線（推奨をデフォルト選択） #}
      {% else %}
        <div>
          {% if recommended_phase == "pre" %}
            <div class="d-flex align-items-center gap-2 mb-1">
              <span class="badge bg-success">おすすめ</span>
              <span class="text-uppercase text-muted small fw-bold">自己記入式検査</span>
            </div>
            <h1 class="h4 fw-bold mb-0">{{ patient.name }} さん</h1>
            <p class="text-muted small mb-2">{{ recommendation_reason }}</p>
          {% elif recommended_phase == "post" %}
            <div class="d-flex align-items-center gap-2 mb-1">
              <span class="badge bg-success">おすすめ</span>
              <span class="text-uppercase text-muted small fw-bold">自己記入式検査</span>
            </div>
            <h1 class="h4 fw-bold mb-0">{{ patient.name }} さん</h1>
            <p class="text-muted small mb-2">{{ recommendation_reason }}</p>
          {% else %}
            <div class="text-uppercase text-muted small fw-bold">自己記入式検査</div>
            <h1 class="h4 fw-bold mb-0">{{ patient.name }} さん</h1>
            <p class="text-muted small mb-2">スタッフが目的に応じて「治療前」または「治療後」を選択し、「検査を開始」ボタンを押してください。</p>
          {% endif %}
          <p class="text-muted small mb-0">治療回数: {{ completed_count }}回{% if first_treatment_date %} / 初回治療日: {{ first_treatment_date|date:"Y/m/d" }}{% endif %}</p>
        </div>
        <form method="post" action="{% url 'patient_portal:start' %}">
          {% csrf_token %}
          <div class="d-flex flex-wrap align-items-center gap-3 mb-2">
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="phase" id="phasePre" value="pre" required
                {% if recommended_phase == "pre" and not latest_pre %}checked{% elif recommended_phase == "pre" and latest_pre.status != "submitted" %}checked{% elif recommended_phase != "post" and latest_post and latest_post.status == "submitted" %}checked{% endif %}
                {% if latest_pre and latest_pre.status == "submitted" %}disabled{% endif %}>
              <label class="form-check-label fw-bold" for="phasePre">治療前{% if latest_pre and latest_pre.status == "submitted" %}（完了）{% endif %}</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" name="phase" id="phasePost" value="post"
                {% if recommended_phase == "post" and not latest_post %}checked{% elif recommended_phase == "post" and latest_post.status != "submitted" %}checked{% elif recommended_phase != "pre" and latest_pre and latest_pre.status == "submitted" %}checked{% endif %}
                {% if latest_post and latest_post.status == "submitted" %}disabled{% endif %}>
              <label class="form-check-label fw-bold" for="phasePost">治療後{% if latest_post and latest_post.status == "submitted" %}（完了）{% endif %}</label>
            </div>
            <button type="submit" id="startButton" class="btn btn-primary btn-lg px-4"><i class="fas fa-play me-2"></i><span id="buttonText">検査を開始</span></button>
          </div>
          <div class="text-muted small">
            <span class="me-3">治療前: {% if latest_pre %}{{ latest_pre.get_status_display }}{% else %}未実施{% endif %}</span>
            <span>治療後: {% if latest_post %}{{ latest_post.get_status_display }}{% else %}未実施{% endif %}</span>
          </div>
        </form>
      {% endif %}

      {% if active_sessions %}
        <div class="mt-2">
          <div class="fw-bold mb-1">進行中または過去のセッション</div>
          <div class="list-group">
            {% for s in active_sessions %}
              <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" href="{% url 'patient_portal:review' s.id %}">
                <div>
                  <div class="small text-muted">{{ s.get_phase_display }} / {{ s.started_at|date:"Y/m/d H:i" }}</div>
                  <div class="fw-bold">状態: {{ s.get_status_display }}</div>
                </div>
                <i class="fas fa-chevron-right text-muted"></i>
              </a>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
  function updateButtonText() {
    const prePre = document.getElementById('phasePre');
    const phasePost = document.getElementById('phasePost');
    const buttonText = document.getElementById('buttonText');
    
    if (prePre && prePre.checked) {
      buttonText.textContent = '治療前の検査を開始';
    } else if (phasePost && phasePost.checked) {
      buttonText.textContent = '治療後の検査を開始';
    } else {
      buttonText.textContent = '検査を開始';
    }
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    const prePre = document.getElementById('phasePre');
    const phasePost = document.getElementById('phasePost');
    
    if (prePre) {
      prePre.addEventListener('change', updateButtonText);
    }
    if (phasePost) {
      phasePost.addEventListener('change', updateButtonText);
    }
    
    // 初期表示時もテキストを更新
    updateButtonText();
  });
</script>
{% endblock %}