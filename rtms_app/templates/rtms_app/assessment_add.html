{% extends "rtms_app/base.html" %}
{% load static %}

{% block body_class %}page-assessment{% endblock %}

{% block header_breadcrumb %}
  <span class="text-white-50 ms-2">/ 尺度評価</span>
{% endblock header_breadcrumb %}

{% block extrastyle %}
<style>
  .score-input { width: 64px; text-align: center; font-weight: 700; }
  .hamd-row { border: 1px solid #e9ecef; border-radius: 10px; background: #fff; }
  .hamd-row:hover { border-color: var(--color-assessment); background: #fef8f8; }
  .q-badge { width: 28px; height: 28px; background: #f1f3f5; color: #495057; border-radius: 999px; display:flex; align-items:center; justify-content:center; font-weight:700; font-size: .8rem; }
  .help-icon { color: var(--color-assessment); cursor:pointer; opacity:.75; }
  .help-icon:hover { opacity:1; }
  .popover { max-width: 420px; }
  .popover-body { white-space: pre-wrap; font-size: .9rem; }
  .sticky-scorebar {
    position: sticky; bottom: 0; z-index: 1020;
    background: #fff; border-top: 2px solid var(--color-assessment);
    padding: 10px 12px;
  }
  .compact-label { font-size:.92rem; line-height:1.2; }

  /* iPad Landscape Optimization */
  @media only screen and (min-width: 1000px) and (orientation: landscape) {
      .container { max-width: 98vw; padding-top: 10px !important; padding-bottom: 60px !important; }
      h4 { font-size: 1.2rem; margin-bottom: 0.5rem !important; }
      .alert { padding: 0.25rem 0.5rem; margin-bottom: 0.5rem !important; font-size: 0.85rem; }
      
      .card-header { padding: 0.25rem 0.5rem; font-size: 0.9rem; }
      .card-body { padding: 0.5rem; }
      
      .hamd-row { padding: 0.25rem !important; margin-bottom: 0.2rem; }
      .q-badge { width: 22px; height: 22px; font-size: 0.7rem; }
      .compact-label { font-size: 0.8rem; }
      
      .btn-group-sm>.btn, .btn-sm { padding: 0.1rem 0.3rem; font-size: 0.75rem; }
      
      /* Make 2 columns become 3 columns if space permits, or just tighter 2 columns */
      .col-lg-6 { width: 50%; } 
      
      .sticky-scorebar { padding: 5px 10px; }
      .sticky-scorebar .h5 { font-size: 1rem; }
      .sticky-scorebar .btn { padding: 0.25rem 0.5rem; font-size: 0.85rem; }
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-3 mb-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="fw-bold mb-0"><i class="fas fa-chart-bar page-title-icon"></i> 尺度評価 (HAM-D)</h4>
  </div>

  {% include "rtms_app/partials/form_header.html" %}

  {% if recommendation %}
    <div class="alert alert-info fw-bold mb-3 shadow-sm"><i class="fas fa-comment-medical"></i> {{ recommendation }}</div>
  {% endif %}

  <!-- ★ 期限ではなく評価予定日レンジ -->
  <div class="alert alert-secondary mb-3 shadow-sm">
    <i class="fas fa-calendar-alt me-1"></i>
    <span class="fw-bold">評価予定日：</span>
    {{ window_start|date:"Y年n月j日" }}〜{{ window_end|date:"Y年n月j日" }}
    <span class="ms-2 text-muted small">（{{ initial_timing_display }}）</span>
  </div>

  <form method="post" id="assessmentForm">
    {% csrf_token %}

    <div class="card shadow-sm border-0">
      <div class="card-header text-white d-flex justify-content-between align-items-center" style="background-color: var(--color-assessment);">
        <div class="fw-bold">
          {% if existing_assessment %}
            <i class="fas fa-edit"></i> 評価の編集 (保存済み)
          {% else %}
            <i class="fas fa-pen"></i> 新規評価入力
          {% endif %}
        </div>
        <div class="d-flex align-items-center gap-2">
          <div class="small">実施日</div>
          <input type="date" name="date" class="form-control form-control-sm" value="{{ default_date|date:'Y-m-d' }}" style="width:auto;">
        </div>
      </div>

      <div class="card-body bg-light">
        <div class="row g-2">
          <div class="col-lg-6">
            <div class="d-flex flex-column gap-2">
              {% for key, label, max, text in hamd_items_left %}
                <div class="hamd-row p-2 d-flex align-items-center justify-content-between"
                     data-bs-toggle="popover"
                     data-bs-placement="auto"
                     data-bs-trigger="hover focus"
                     data-bs-content="{{ text }}">
                  <div class="d-flex align-items-center gap-2 flex-grow-1 me-2">
                    <div class="q-badge">Q{{ forloop.counter }}</div>
                    <div class="fw-bold compact-label">{{ label }}</div>
                  </div>
                  <div class="text-end">
                    <input type="hidden" name="{{ key }}" value="0">
                    <div class="btn-group btn-group-sm hamd-btn-group" role="group" data-hamd-key="{{ key }}">
                      {% if max == 2 %}
                        {% for v in "012"|make_list %}
                          <button type="button" class="btn btn-outline-primary hamd-btn" data-value="{{ v }}">{{ v }}</button>
                        {% endfor %}
                      {% elif max == 3 %}
                        {% for v in "0123"|make_list %}
                          <button type="button" class="btn btn-outline-primary hamd-btn" data-value="{{ v }}">{{ v }}</button>
                        {% endfor %}
                      {% else %}
                        {% for v in "01234"|make_list %}
                          <button type="button" class="btn btn-outline-primary hamd-btn" data-value="{{ v }}">{{ v }}</button>
                        {% endfor %}
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>

          <div class="col-lg-6">
            <div class="d-flex flex-column gap-2">
              {% for key, label, max, text in hamd_items_right %}
                <div class="hamd-row p-2 d-flex align-items-center justify-content-between"
                     data-bs-toggle="popover"
                     data-bs-placement="auto"
                     data-bs-trigger="hover focus"
                     data-bs-content="{{ text }}">
                  <div class="d-flex align-items-center gap-2 flex-grow-1 me-2">
                    <div class="q-badge">Q{{ forloop.counter|add:11 }}</div>
                    <div class="fw-bold compact-label">{{ label }}</div>
                  </div>
                  <div class="text-end">
                    <input type="hidden" name="{{ key }}" value="0">
                    <div class="btn-group btn-group-sm hamd-btn-group" role="group" data-hamd-key="{{ key }}">
                      {% if max == 2 %}
                        {% for v in "012"|make_list %}
                          <button type="button" class="btn btn-outline-primary hamd-btn" data-value="{{ v }}">{{ v }}</button>
                        {% endfor %}
                      {% elif max == 3 %}
                        {% for v in "0123"|make_list %}
                          <button type="button" class="btn btn-outline-primary hamd-btn" data-value="{{ v }}">{{ v }}</button>
                        {% endfor %}
                      {% else %}
                        {% for v in "01234"|make_list %}
                          <button type="button" class="btn btn-outline-primary hamd-btn" data-value="{{ v }}">{{ v }}</button>
                        {% endfor %}
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="mt-3 bg-white p-3 rounded border">
          <label class="form-label fw-bold"><i class="fas fa-comment-dots me-1"></i>コメント・特記事項</label>
          <textarea name="note" id="id_note" class="form-control" rows="3"
            placeholder="判定結果や特記事項があれば入力してください">{{ existing_assessment.note|default:"" }}</textarea>
        </div>
      </div>

      <!-- 保存操作は右下のフローティングメニューに統一 -->

      <!-- ★ リアルタイム合計＆重症度（sticky） -->
      <div class="sticky-scorebar shadow">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
          <div class="fw-bold">
            HAMD17 合計：<span id="hamd17Total" style="color: var(--color-assessment);">0</span> 点
            <span class="ms-2">重症度：<span id="hamd17Severity" class="text-primary">正常</span></span>
          </div>
          <div class="text-muted small">
            HAMD17 参考基準: 0-7:正常 | 8-13:軽症 | 14-18:中等症 | 19-22:重症 | 23-:最重症
          </div>
        </div>
      </div>

    </div>
  </form>
</div>

{% url 'rtms_app:dashboard' as dashboard_url %}
    {% if dashboard_date %}
      {% with back_url=dashboard_url|add:"?date="|add:dashboard_date %}
        <link rel="stylesheet" href="{% static 'rtms_app/floating.css' %}">
        <script src="{% static 'rtms_app/floating.js' %}"></script>

        <div class="fab-stack no-print">
          <button type="button" class="btn btn-assessment fab" onclick="RTMSFloating.submitFormById('assessmentForm')">
            <i class="fas fa-save"></i> 保存
          </button>
          <a class="btn btn-secondary fab" href="{{ back_url }}">
            <i class="fas fa-undo"></i> 戻る
          </a>
        </div>
      {% endwith %}
    {% else %}
      <link rel="stylesheet" href="{% static 'rtms_app/floating.css' %}">
      <script src="{% static 'rtms_app/floating.js' %}"></script>

      <div class="fab-stack no-print">
        <button type="button" class="btn btn-assessment fab" onclick="RTMSFloating.submitFormById('assessmentForm')">
          <i class="fas fa-save"></i> 保存
        </button>
        <a class="btn btn-secondary fab" href="{{ dashboard_url }}">
          <i class="fas fa-undo"></i> 戻る
        </a>
      </div>
    {% endif %}

  {# Embed scores safely and restore hidden inputs BEFORE loading the widget script #}
  {% if existing_assessment %}
    {{ existing_assessment.scores|json_script:"assessmentScores" }}
  {% else %}
    {{ "{}"|json_script:"assessmentScores" }}
  {% endif %}

  <script>
  (function(){
    const el = document.getElementById('assessmentScores');
    if (!el) return;
    let scores = {};
    try { scores = JSON.parse(el.textContent || '{}'); } catch(e) { scores = {}; }
    for (const [key, value] of Object.entries(scores)) {
      const hidden = document.querySelector(`#assessmentForm input[name="${key}"][type="hidden"]`);
      if (hidden) hidden.value = String(value);
    }
  })();
  </script>
{% endblock %}

{% block scripts %}
<script src="{% static 'rtms_app/hamd_widget.js' %}"></script>
{% endblock %}
