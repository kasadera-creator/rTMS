{% extends "rtms_app/base.html" %}
{% load static %}

{% block extrastyle %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* ===== 共通 ===== */
.tooltip-inner {
    max-width: 420px !important;
    text-align: left !important;
    white-space: pre-wrap;
    font-size: 0.85rem;
}
.help-icon {
    color: #0d6efd;
    cursor: pointer;
    font-size: 0.95rem;
    margin-left: 6px;
    opacity: .75;
}
.help-icon:hover { opacity: 1; }

/* ===== 項目カード ===== */
.item-row {
    border: 1px solid #e6e6e6;
    border-radius: 8px;
    background: #ffffff;
}
.item-row:hover {
    border-color: #0d6efd;
    background: #f8fbff;
}

/* ===== スコアボタン ===== */
.score-btns .btn {
    padding: .15rem .45rem;
    font-weight: 700;
}
.score-btns .btn-outline-primary {
    --bs-btn-color: #0d6efd;
    --bs-btn-border-color: #ced4da;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-4 mb-5">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold">
            <i class="fas fa-chart-bar text-danger"></i>
            尺度評価（HAM-D / STAR*D SIGH-D）
        </h3>
        {% include "rtms_app/partials/patient_nav.html" %}
    </div>

    {% include "rtms_app/partials/form_header.html" %}

    {% if recommendation %}
        <div class="alert alert-info fw-bold shadow-sm mb-3">
            <i class="fas fa-comment-medical"></i> {{ recommendation }}
        </div>
    {% endif %}

    {% if deadline %}
        <div class="alert alert-warning fw-bold shadow-sm mb-3">
            <i class="fas fa-clock"></i>
            評価期限：{{ deadline|date:"Y年n月j日" }}
        </div>
    {% endif %}

    <form method="post" id="assessmentForm">
        {% csrf_token %}

        <div class="card shadow-sm border-0">
            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center p-3">
                <h5 class="mb-0">
                    {% if existing_assessment %}
                        <i class="fas fa-edit"></i> 評価の編集（保存済み）
                    {% else %}
                        <i class="fas fa-pen"></i> 新規評価入力
                    {% endif %}
                </h5>
                <div class="d-flex align-items-center gap-2">
                    <label class="small mb-0">実施日</label>
                    <input type="date"
                           name="date"
                           class="form-control form-control-sm"
                           value="{{ today }}"
                           style="width:auto;">
                </div>
            </div>

            <div class="card-body bg-light p-3">
                <div class="row g-3">

                    <!-- ===== 左カラム ===== -->
                    <div class="col-md-6">
                        <div class="d-flex flex-column gap-2">
                            {% for key, label, max, text in hamd_items_left %}
                            <div class="item-row p-2 d-flex align-items-center justify-content-between">
                                <div class="me-2" style="min-width:220px;">
                                    <div class="fw-bold small lh-sm">
                                        {{ label|slice:"3:" }}
                                        <i class="fas fa-info-circle help-icon"
                                           data-bs-toggle="tooltip"
                                           title="{{ text }}"></i>
                                    </div>
                                </div>

                                <div class="btn-group btn-group-sm score-btns" role="group">
                                    {% for n in "0123456789"|make_list %}
                                        {% if forloop.counter0 <= max %}
                                        <input type="radio"
                                               class="btn-check"
                                               name="{{ key }}"
                                               id="id_{{ key }}_{{ forloop.counter0 }}"
                                               value="{{ forloop.counter0 }}"
                                               autocomplete="off">
                                        <label class="btn btn-outline-primary"
                                               for="id_{{ key }}_{{ forloop.counter0 }}">
                                            {{ forloop.counter0 }}
                                        </label>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- ===== 右カラム ===== -->
                    <div class="col-md-6">
                        <div class="d-flex flex-column gap-2">
                            {% for key, label, max, text in hamd_items_right %}
                            <div class="item-row p-2 d-flex align-items-center justify-content-between">
                                <div class="me-2" style="min-width:220px;">
                                    <div class="fw-bold small lh-sm">
                                        {{ label|slice:"3:" }}
                                        <i class="fas fa-info-circle help-icon"
                                           data-bs-toggle="tooltip"
                                           title="{{ text }}"></i>
                                    </div>
                                </div>

                                <div class="btn-group btn-group-sm score-btns" role="group">
                                    {% for n in "0123456789"|make_list %}
                                        {% if forloop.counter0 <= max %}
                                        <input type="radio"
                                               class="btn-check"
                                               name="{{ key }}"
                                               id="id_{{ key }}_{{ forloop.counter0 }}"
                                               value="{{ forloop.counter0 }}"
                                               autocomplete="off">
                                        <label class="btn btn-outline-primary"
                                               for="id_{{ key }}_{{ forloop.counter0 }}">
                                            {{ forloop.counter0 }}
                                        </label>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                </div>

                <!-- ===== コメント ===== -->
                <div class="mt-4 bg-white p-3 rounded border">
                    <label class="form-label fw-bold">
                        <i class="fas fa-comment-dots me-1"></i>
                        コメント・特記事項
                    </label>
                    <textarea name="note"
                              class="form-control"
                              rows="3"
                              placeholder="評価上の補足、臨床的判断など">{{ existing_assessment.note|default:"" }}</textarea>
                </div>
            </div>

            <div class="card-footer text-center bg-white p-3">
                <button type="submit"
                        class="btn btn-primary btn-lg px-5 fw-bold shadow-sm">
                    <i class="fas fa-save me-2"></i> 評価を保存
                </button>
            </div>
        </div>
    </form>
</div>

{% url 'rtms_app:dashboard' as dashboard_url %}
{% include "rtms_app/partials/floating_actions.html" with back_url=dashboard_url form_id='assessmentForm' %}
{% endblock %}

{% block extrascript %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {

    // tooltip 初期化
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
        new bootstrap.Tooltip(el);
    });

    {% if existing_assessment %}
        // 既存スコア復元
        const scores = {{ existing_assessment.scores|safe }};
        for (const [key, value] of Object.entries(scores)) {
            const radio = document.getElementById(`id_${key}_${value}`);
            if (radio) radio.checked = true;
        }
    {% else %}
        // 新規時は全項目 0 をデフォルト
        document.querySelectorAll('input.btn-check[value="0"]').forEach(r => r.checked = true);
    {% endif %}
});
</script>
{% endblock %}
