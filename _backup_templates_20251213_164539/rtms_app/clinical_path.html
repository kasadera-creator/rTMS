{% extends "rtms_app/base.html" %}

{% block extrastyle %}
<style>
    /* 画面表示用スタイル */
    .path-container { background-color: white; padding: 30px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
    .calendar-wrapper { margin-bottom: 40px; }
    .month-title { font-weight: bold; font-size: 1.2rem; margin: 10px 0; border-left: 5px solid #0d6efd; padding-left: 10px; }
    .cal-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; table-layout: fixed; }
    .cal-table th { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 8px; text-align: center; }
    .cal-table td { border: 1px solid #dee2e6; height: 100px; vertical-align: top; padding: 5px; font-size: 0.9rem; }
    .day-num { font-weight: bold; display: block; margin-bottom: 5px; }
    .event-badge { display: block; padding: 2px 4px; margin-bottom: 2px; border-radius: 3px; font-size: 0.8rem; color: white; text-align: center; }
    
    .event-admission { background-color: #0d6efd; }
    .event-mapping { background-color: #fd7e14; }
    .event-treatment { background-color: #198754; }
    .event-treatment.done { background-color: #146c43; opacity: 0.7; text-decoration: line-through; }
    .event-assessment { background-color: #dc3545; }
    .event-discharge { background-color: #0dcaf0; color: #000; }

    /* 裏面（説明）スタイル */
    .instruction-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
    .instruction-table th, .instruction-table td { border: 1px solid #000; padding: 8px; }
    .instruction-table th { background-color: #e9ecef; width: 150px; text-align: center; vertical-align: middle; }
    
    /* 印刷用 */
    @media print {
        @page { size: A4; margin: 10mm; }
        body { background-color: white; margin: 0; }
        .no-print { display: none !important; }
        .path-container { box-shadow: none; padding: 0; }
        
        .page-break { page-break-before: always; }
        .print-header { text-align: center; margin-bottom: 20px; }
        .cal-table td { height: 80px; font-size: 10pt; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- ヘッダー (画面のみ) -->
    <div class="d-flex justify-content-between align-items-center mb-4 no-print">
        <h3><i class="fas fa-route"></i> クリニカルパス表示</h3>
        <div class="btn-group">
            <button class="btn btn-outline-primary" onclick="window.print()"><i class="fas fa-print"></i> 印刷</button>
            <a href="{% url 'patient_list' %}" class="btn btn-secondary">一覧に戻る</a>
        </div>
    </div>

    <div class="path-container">
        
        <!-- 表面: カレンダー -->
        <div class="print-header">
            <h2>rTMS治療スケジュール表</h2>
            <div class="d-flex justify-content-between mt-3 px-2">
                <div>氏名: <strong>{{ patient.name }} 様</strong></div>
                <div>ID: {{ patient.card_id }}</div>
                <div>担当医: {{ patient.attending_physician.last_name }}</div>
            </div>
        </div>

        <div class="calendar-wrapper">
            {% for month in calendar_months %}
            <div class="month-title">{{ month.year }}年 {{ month.month }}月</div>
            <table class="cal-table">
                <thead>
                    <tr>
                        <th class="text-danger">日</th>
                        <th>月</th><th>火</th><th>水</th><th>木</th><th>金</th>
                        <th class="text-primary">土</th>
                    </tr>
                </thead>
                <tbody>
                    {% for week in month.weeks %}
                    <tr>
                        {% for day in week %}
                        <td>
                            {% if day %}
                                <span class="day-num">{{ day.day }}</span>
                                {% for event in day.events %}
                                    <span class="event-badge event-{{ event.type }} {% if event.done %}done{% endif %}">
                                        {{ event.label }}
                                    </span>
                                {% endfor %}
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endfor %}
        </div>

        <!-- 改ページ (印刷時) -->
        <div class="page-break"></div>

        <!-- 裏面: 説明表 -->
        <div class="mt-5">
            <div class="print-header">
                <h2>rTMS治療 入院中の過ごし方</h2>
            </div>
            
            <table class="instruction-table">
                <thead>
                    <tr>
                        <th>項目</th>
                        <th>入院日</th>
                        <th>位置決め日（初回）</th>
                        <th>治療実施日</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <th>達成目標</th>
                        <td>
                            ・病棟生活のオリエンテーションを受ける<br>
                            ・主治医から治療説明を受ける
                        </td>
                        <td>
                            ・rTMS治療の刺激部位を決定する<br>
                            ・治療中の体勢や感覚を確認する
                        </td>
                        <td>
                            ・副作用なく安全に治療を受ける<br>
                            ・規則正しい生活リズムを整える
                        </td>
                    </tr>
                    <tr>
                        <th>治療・処置</th>
                        <td>
                            ・持参薬の確認<br>
                            ・バイタルサイン測定
                        </td>
                        <td>
                            ・MT（運動閾値）測定の実施<br>
                            ・マーキング（頭部）
                        </td>
                        <td>
                            ・rTMS治療（約40分間）<br>
                            ・治療前後の気分・体調確認
                        </td>
                    </tr>
                    <tr>
                        <th>活動・安静</th>
                        <td>
                            ・病棟内フリー<br>
                            ・外出・外泊は主治医の許可が必要
                        </td>
                        <td>
                            ・治療中は安静保持<br>
                            ・終了後は病棟内フリー
                        </td>
                        <td>
                            ・治療後は通常通り活動可<br>
                            ・過度な疲労を避ける
                        </td>
                    </tr>
                    <tr>
                        <th>食事</th>
                        <td colspan="3" class="text-center">
                            ・常食（特別な制限はありません）<br>
                            ・カフェインの過剰摂取は控えてください
                        </td>
                    </tr>
                    <tr>
                        <th>保清</th>
                        <td colspan="3" class="text-center">
                            ・入浴・シャワー浴ともに可能です
                        </td>
                    </tr>
                    <tr>
                        <th>備考</th>
                        <td>
                            ・不明点があればスタッフへ
                        </td>
                        <td>
                            ・刺激時に痛みがある場合は伝えてください
                        </td>
                        <td>
                            ・頭痛や不快感があれば早めに報告を
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="mt-4 p-3 border border-dark">
                <strong>【注意事項】</strong>
                <ul class="mb-0">
                    <li>治療スケジュールは、機器の状況や医師の判断により変更になる場合があります。</li>
                    <li>体調不良時は無理せず、スタッフにお申し出ください。</li>
                    <li>土日祝日は原則として治療はお休みです。</li>
                </ul>
            </div>
        </div>

    </div>
</div>
{% endblock %}