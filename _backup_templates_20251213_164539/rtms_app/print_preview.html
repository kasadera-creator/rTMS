{% extends "rtms_app/base.html" %}

{% block extrastyle %}
<style>
    /* 画面表示用（プレビュー背景） */
    body { background-color: #525659; }
    .preview-container { width: 210mm; margin: 20px auto; }
    .page-sheet {
        background-color: white; width: 100%; min-height: 297mm; 
        padding: 10mm; /* 余白 */
        box-shadow: 0 0 10px rgba(0,0,0,0.5); position: relative; box-sizing: border-box; margin-bottom: 20px;
        font-family: "Hiragino Mincho ProN", "Yu Mincho", "MS PMincho", serif; color: #000; 
        line-height: 1.3;
    }
    @media print {
        @page { size: A4; margin: 0; }
        body { background-color: white; margin: 0; }
        .preview-container { width: 100%; margin: 0; }
        .page-sheet { 
            width: 100%; margin: 0; padding: 10mm; box-shadow: none; border: none; min-height: 297mm;
        }
        .no-print { display: none !important; }
        a[href]:after { content: none !important; }
    }

    /* --- サマリー用スタイル --- */
    h1.summary-title { font-size: 16pt; text-align: center; border-bottom: 2px solid #000; margin-bottom: 10px; padding-bottom: 4px; margin-top: 0; }
    .basic-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 6px; }
    .basic-info-item { font-size: 9.5pt; }
    .basic-info-item label { font-weight: bold; margin-right: 8px; }
    
    .summary-table { width: 100%; border-collapse: collapse; margin-bottom: 8px; font-size: 9.5pt; }
    .summary-table th, .summary-table td { border: 1px solid #000; padding: 3px 5px; vertical-align: top; }
    .summary-table th { background-color: #f0f0f0 !important; -webkit-print-color-adjust: exact; width: 90px; text-align: left; font-weight: normal; }
    
    .schedule-table { width: 100%; border-collapse: collapse; font-size: 9pt; margin-top: 5px; }
    .schedule-table th, .schedule-table td { border: 1px solid #000; padding: 3px; text-align: center; }
    .schedule-table th { background-color: #e0e0e0 !important; -webkit-print-color-adjust: exact; }

    /* --- 問診票用スタイル (修正版) --- */
    .q-header-sub { font-size: 9pt; margin-bottom: 0; text-align: right; }
    .q-title-main { font-size: 16pt; text-align: center; font-weight: bold; margin: 0 0 10px 0; letter-spacing: 1px; }
    .q-intro { font-size: 9.5pt; margin-bottom: 10px; text-align: justify; line-height: 1.3; }
    
    .q-section-title { font-size: 10.5pt; font-weight: bold; margin-top: 10px; margin-bottom: 5px; border-bottom: 1px solid #000; display: inline-block; }
    
    .q-form-table { width: 100%; border-collapse: collapse; font-size: 10pt; }
    .q-form-table td { padding: 4px 0; border-bottom: 1px dotted #ccc; vertical-align: middle; }
    
    /* チェックボックス列 */
    .q-check-col { width: 60px; white-space: nowrap; font-weight: bold; text-align: left; }
    
    /* ★修正: 質問文列の左パディングを大きくして右側に寄せる */
    .q-text-col { 
        text-align: left; 
        padding-left: 60px !important; /* 40px -> 60px に増量 */
    }
    
    .cb-mark { font-family: "Arial", sans-serif; font-size: 13pt; display: inline-block; width: 1.2em; vertical-align: -1px; }
    
    /* 自由記述欄 */
    .q-details-box { border: 1px solid #000; min-height: 80px; margin-top: 5px; padding: 5px; font-size: 10pt; white-space: pre-wrap; }
    
    /* 署名欄 */
    .signature-section { margin-top: 20px; display: flex; justify-content: flex-end; gap: 20px; }
    .signature-block { width: 250px; }
    .signature-line { border-bottom: 1px solid #000; margin-top: 15px; position: relative; }
    .signature-label { margin-bottom: 2px; font-weight: bold; font-size: 10pt; }
    .date-line { text-align: right; margin-top: 2px; font-size: 9pt; }

    .hospital-footer { text-align: center; font-weight: bold; font-size: 11pt; margin-top: 15px; border-top: 3px double #000; padding-top: 5px; width: 50%; margin-left: auto; margin-right: auto; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid no-print bg-dark text-white p-2 fixed-top">
    <div class="container d-flex justify-content-between align-items-center">
        <span>
            {% if mode == 'summary' %}初診時サマリープレビュー{% else %}適正質問票プレビュー{% endif %}
        </span>
        <div>
            <button onclick="window.print()" class="btn btn-primary btn-sm"><i class="fas fa-print"></i> 印刷する</button>
            <button onclick="window.close()" class="btn btn-secondary btn-sm">閉じる</button>
        </div>
    </div>
</div>
<div style="height: 50px;" class="no-print"></div>

<div class="preview-container">
    
    <!-- 1. 初診時サマリー -->
    {% if mode == 'summary' %}
    <div class="page-sheet">
        <div style="text-align: right; font-size: 9pt;">作成日: {% now "Y年n月j日" %}</div>
        <h1 class="summary-title">rTMS 初診時サマリー</h1>

        <div class="basic-info-grid">
            <div class="basic-info-item"><label>ID:</label> {{ patient.card_id }}</div>
            <div class="basic-info-item"><label>氏名:</label> {{ patient.name }} 様</div>
            <div class="basic-info-item"><label>生年月日:</label> {{ patient.birth_date|date:"Y年n月j日" }} ({{ patient.age }}歳)</div>
            <div class="basic-info-item"><label>性別:</label> {{ patient.get_gender_display }}</div>
            <div class="basic-info-item"><label>紹介元:</label> {{ patient.referral_source|default:"-" }}</div>
            <div class="basic-info-item"><label>初診担当医:</label> {{ request.user.last_name }}</div>
        </div>

        <table class="summary-table">
            <tr><th>診断名</th><td>{{ patient.diagnosis }}</td></tr>
            <tr><th>主訴</th><td>{{ patient.chief_complaint|default:"-" }}</td></tr>
            <tr><th>生活歴</th><td>{{ patient.life_history|linebreaksbr|default:"-" }}</td></tr>
            <tr><th>既往歴</th><td>{{ patient.past_history|linebreaksbr|default:"-" }}</td></tr>
            <tr><th>現病歴</th><td>{{ patient.present_illness|linebreaksbr|default:"-" }}</td></tr>
            <tr><th>薬剤治療歴</th><td>{{ patient.medication_history|linebreaksbr|default:"-" }}</td></tr>
        </table>

        <div class="mt-4">
            <h3 style="font-size: 10.5pt; font-weight: bold; border-bottom: 1px solid #000; margin-bottom: 5px;">今後の予定・スケジュール</h3>
            <div style="margin-bottom: 5px; font-size: 10pt;">
                <strong>主治医（担当医）：</strong> 
                {% if patient.attending_physician %}{{ patient.attending_physician.last_name }}{% else %}<span style="color: #999;">（未定）</span>{% endif %}
            </div>
            <table class="schedule-table">
                <tr><th>入院予定日</th><th>初回位置決め</th><th>初回治療日</th><th>治療終了予定 (30回)</th></tr>
                <tr>
                    <td>{{ patient.admission_date|default:"-" }}</td>
                    <td>{{ patient.mapping_date|default:"-" }}</td>
                    <td>{{ patient.first_treatment_date|default:"-" }}</td>
                    <td>{{ end_date_est|date:"Y-m-d"|default:"-" }}</td>
                </tr>
            </table>
        </div>
        <div style="position: absolute; bottom: 10mm; right: 10mm; font-size: 9pt;">笠寺精治寮病院</div>
    </div>
    {% endif %}

    <!-- 2. 適正質問票 -->
    {% if mode == 'questionnaire' %}
    <div class="page-sheet">
        <div class="q-header-sub">参考資料3 rTMS適正質問票および副作用チェック表</div>
        <h2 class="q-title-main">反復経頭蓋磁気刺激療法(rTMS)の適正に関する質問票</h2>
        <p class="q-intro">反復経頭蓋磁気刺激療法(rTMS) を安全に行うために以下の質問にわかる範囲でお答えください。後ほど本質問票と現在の処方内容に基づいて担当医より問診し、rTMS療法の適正を判断させていただきます。</p>

        {% with q=patient.questionnaire_data %}
        <div class="q-section-title">これまでに、以下のことがありましたか？</div>
        <table class="q-form-table">
            <tr><td class="q-check-col"><span class="cb-mark">{% if q.q_past_rtms == 'はい' %}☑{% else %}□{% endif %}</span> はい</td><td class="q-check-col"><span class="cb-mark">{% if q.q_past_rtms == 'いいえ' %}☑{% else %}□{% endif %}</span> いいえ</td><td class="q-text-col">rTMS実施経験（治験、研究を問わない）</td></tr>
            <tr><td class="q-check-col"><span class="cb-mark">{% if q.q_past_side_effect == 'はい' %}☑{% else %}□{% endif %}</span> はい</td><td class="q-check-col"><span class="cb-mark">{% if q.q_past_side_effect == 'いいえ' %}☑{% else %}□{% endif %}</span> いいえ</td><td class="q-text-col">rTMSのあとに副作用などの不快な経験</td></tr>
            <tr><td class="q-check-col"><span class="cb-mark">{% if q.q_past_ect == 'はい' %}☑{% else %}□{% endif %}</span> はい</td><td class="q-check-col"><span class="cb-mark">{% if q.q_past_ect == 'いいえ' %}☑{% else %}□{% endif %}</span> いいえ</td><td class="q-text-col">電気けいれん療法（副作用の有無など）</td></tr>
            <tr><td class="q-check-col"><span class="cb-mark">{% if q.q_past_seizure == 'はい' %}☑{% else %}□{% endif %}</span> はい</td><td class="q-check-col"><span class="cb-mark">{% if q.q_past_seizure == 'いいえ' %}☑{% else %}□{% endif %}</span> いいえ</td><td class="q-text-col">けいれん発作（てんかんの診断の有無を問わない）</td></tr>
            <tr><td class="q-check-col"><span class="cb-mark">{% if q.q_past_loc == 'はい' %}☑{% else %}□{% endif %}</span> はい</td><td class="q-check-col"><span class="cb-mark">{% if q.q_past_loc == 'いいえ' %}☑{% else %}□{% endif %}</span> いいえ</td><td class="q-text-col">意識消失発作</td></tr>
            <tr><td class="q-check-col"><span class="cb-mark">{% if q.q_past_stroke == 'はい' %}☑{% else %}□{% endif %}</span> はい</td><td class="q-check-col"><span class="cb-mark">{% if q.q_past_stroke == 'いいえ' %}☑{% else %}□{% endif %}</span> いいえ</td><td class="q-text-col">脳卒中（脳梗塞や脳出血など）</td></tr>
            <tr><td class="q-check-col"><span class="cb-mark">{% if q.q_past_trauma == 'はい' %}☑{% else %}□{% endif %}</span> はい</td><td class="q-check-col"><span class="cb-mark">{% if q.q_past_trauma == 'いいえ' %}☑{% else %}□{% endif %}</span> いいえ</td><td class="q-text-col">頭部外傷（意識がなくなるなど重度なもの）</td></tr>
            <tr><td class="q-check-col"><span class="cb-mark">{% if q.q_past_surgery == 'はい' %}☑{% else %}□{% endif %}</span> はい</td><td class="q-check-col"><span class="cb-mark">{% if q.q_past_surgery == 'いいえ' %}☑{% else %}□{% endif %}</span> いいえ</td><td class="q-text-col">頭部の手術</td></tr>
            <tr><td class="q-check-col"><span class="cb-mark">{% if q.q_past_neuro == 'はい' %}☑{% else %}□{% endif %}</span> はい</td><td class="q-check-col"><span class="cb-mark">{% if q.q_past_neuro == 'いいえ' %}☑{% else %}□{% endif %}</span> いいえ</td><td class="q-text-col">脳外科もしくは神経内科の病気</td></tr>
            <tr><td class="q-check-col"><span class="cb-mark">{% if q.q_past_internal == 'はい' %}☑{% else %}□{% endif %}</span> はい</td><td class="q-check-col"><span class="cb-mark">{% if q.q_past_internal == 'いいえ' %}☑{% else %}□{% endif %}</span> いいえ</td><td class="q-text-col">脳障害をおこす可能性のある内科疾患</td></tr>
            <tr><td class="q-check-col"><span class="cb-mark">{% if q.q_past_abuse == 'はい' %}☑{% else %}□{% endif %}</span> はい</td><td class="q-check-col"><span class="cb-mark">{% if q.q_past_abuse == 'いいえ' %}☑{% else %}□{% endif %}</span> いいえ</td><td class="q-text-col">アルコールや薬物の乱用</td></tr>
        </table>

        <div class="q-section-title" style="margin-top: 15px;">現在、以下のことはありますか？</div>
        <table class="q-form-table">
            <tr><td class="q-check-col"><span class="cb-mark">{% if q.q_cur_headache == 'はい' %}☑{% else %}□{% endif %}</span> はい</td><td class="q-check-col"><span class="cb-mark">{% if q.q_cur_headache == 'いいえ' %}☑{% else %}□{% endif %}</span> いいえ</td><td class="q-text-col">頻繁または重度な頭痛</td></tr>
            <tr><td class="q-check-col"><span class="cb-mark">{% if q.q_cur_metal == 'はい' %}☑{% else %}□{% endif %}</span> はい</td><td class="q-check-col"><span class="cb-mark">{% if q.q_cur_metal == 'いいえ' %}☑{% else %}□{% endif %}</span> いいえ</td><td class="q-text-col">頭の中に金属や磁性体（チタン製品かどうか要確認）</td></tr>
            <tr><td class="q-check-col"><span class="cb-mark">{% if q.q_cur_device == 'はい' %}☑{% else %}□{% endif %}</span> はい</td><td class="q-check-col"><span class="cb-mark">{% if q.q_cur_device == 'いいえ' %}☑{% else %}□{% endif %}</span> いいえ</td><td class="q-text-col">体内埋め込み式の医療機器（心臓ペースメーカーなど）</td></tr>
            <tr><td class="q-check-col"><span class="cb-mark">{% if q.q_cur_abuse == 'はい' %}☑{% else %}□{% endif %}</span> はい</td><td class="q-check-col"><span class="cb-mark">{% if q.q_cur_abuse == 'いいえ' %}☑{% else %}□{% endif %}</span> いいえ</td><td class="q-text-col">多量の飲酒や薬物の乱用</td></tr>
            <tr><td class="q-check-col"><span class="cb-mark">{% if q.q_cur_preg == 'はい' %}☑{% else %}□{% endif %}</span> はい</td><td class="q-check-col"><span class="cb-mark">{% if q.q_cur_preg == 'いいえ' %}☑{% else %}□{% endif %}</span> いいえ</td><td class="q-text-col">妊娠中、もしくは妊娠の可能性が否定されない</td></tr>
            <tr><td class="q-check-col"><span class="cb-mark">{% if q.q_cur_family_epilepsy == 'はい' %}☑{% else %}□{% endif %}</span> はい</td><td class="q-check-col"><span class="cb-mark">{% if q.q_cur_family_epilepsy == 'いいえ' %}☑{% else %}□{% endif %}</span> いいえ</td><td class="q-text-col">家族内にてんかんを持っているかた</td></tr>
        </table>

        <div style="margin-top: 15px; font-weight: bold; font-size: 10pt;">「はい」とチェックした項目について、より詳しく教えてください。</div>
        <div class="q-details-box">{{ q.q_details|default:"" }}</div>
        {% endwith %}

        <div class="signature-section">
            <div class="signature-block">
                <div class="signature-label">患者署名：</div>
                <div class="signature-line"><span style="font-size: 12pt;">&nbsp;</span></div>
                <div class="date-line">（日付：　　　　年　　月　　日）</div>
            </div>
            <div class="signature-block">
                <div class="signature-label">担当医署名：</div>
                <div class="signature-line"><span style="font-size: 12pt; padding-left: 10px;">{{ request.user.last_name }}</span></div>
                <div class="date-line">（日付：　　　　年　　月　　日）</div>
            </div>
        </div>
        <div class="hospital-footer">笠寺精治寮病院</div>
    </div>
    {% endif %}
</div>
{% endblock %}